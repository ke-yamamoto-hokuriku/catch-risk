<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é‡‘æ²¢ç‰‡ç”º ã‚­ãƒ£ãƒƒãƒå±…é…’å±‹æŒ‡æ•° â€” Catch Izakaya Risk Index</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #020617; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;

/* â”€â”€â”€ Risk Meter â”€â”€â”€ */
function RiskMeter({ pct, color, level, size = 120 }) {
  const [animPct, setAnimPct] = useState(0);
  useEffect(() => { const t = setTimeout(() => setAnimPct(pct), 150); return () => clearTimeout(t); }, [pct]);
  const r = (size - 16) / 2, circ = 2 * Math.PI * r;
  return (
    <div style={{ position: "relative", width: size, height: size, flexShrink: 0 }}>
      <svg viewBox={`0 0 ${size} ${size}`} width={size} height={size}>
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="#1E293B" strokeWidth="8" />
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={color} strokeWidth="8"
          strokeDasharray={`${(animPct/100)*circ} ${circ}`} strokeLinecap="round"
          transform={`rotate(-90 ${size/2} ${size/2})`}
          style={{ transition: "stroke-dasharray 1.2s cubic-bezier(.4,0,.2,1)" }} />
      </svg>
      <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
        <span style={{ fontSize: size*0.23, fontWeight: 800, color, fontFamily: "'DM Mono', monospace" }}>{animPct}</span>
        <span style={{ fontSize: size*0.085, color: "#94A3B8", letterSpacing: 1 }}>{level}</span>
      </div>
    </div>
  );
}

/* â”€â”€â”€ Score Calculation â”€â”€â”€ */
function calcFromData(d) {
  const factors = []; let score = 0;
  if (d.floor != null && d.floor >= 4) { factors.push({ l: "ç©ºä¸­éšï¼ˆé«˜å±¤ï¼‰", det: `${d.floor}F`, w: 2 }); score += 2; }
  else if (d.floor != null && d.floor >= 2) { factors.push({ l: "ç©ºä¸­éš", det: `${d.floor}F`, w: 1 }); score += 1; }
  if (d.cheapCourse != null && d.cheapCourse < 2000) { factors.push({ l: "éç¾å®Ÿçš„ä½ä¾¡æ ¼", det: `é£²æ”¾ä»˜${d.cheapCourse}å††`, w: 2 }); score += 2; }
  else if (d.cheapCourse != null && d.cheapCourse < 3300) { factors.push({ l: "ä½ä¾¡æ ¼ã‚³ãƒ¼ã‚¹", det: `${d.cheapCourse}å††`, w: 1 }); score += 1; }
  if (d.catchKeywords && d.catchKeywords.length >= 3) { factors.push({ l: "ã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€å¤šæ•°", det: `${d.catchKeywords.length}ä»¶æ¤œå‡º`, w: 3 }); score += 3; }
  else if (d.catchKeywords && d.catchKeywords.length > 0) { factors.push({ l: "ã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€æ¤œå‡º", det: `${d.catchKeywords.length}ä»¶`, w: 2 }); score += 2; }
  if (d.sameAddress) { factors.push({ l: "åŒä½æ‰€ã«åˆ¥åº—èˆ—", det: d.sameAddress, w: 1 }); score += 1; }
  if (d.crownName) { factors.push({ l: "SEOçš„å† èªãƒ‘ã‚¿ãƒ¼ãƒ³", det: "ã€Œå€‹å®¤ã€ã€Œå®Œå…¨å€‹å®¤ã€ç­‰ã‚’åº—åã«ä½¿ç”¨", w: 1 }); score += 1; }
  if (d.gmap != null && d.gmap <= 3.5) { factors.push({ l: "Gãƒãƒƒãƒ—ä½è©•ä¾¡", det: `â˜…${d.gmap}`, w: 1 }); score += 1; }
  if (d.tabelog != null && d.gmap != null) {
    const diff = d.gmap - d.tabelog;
    if (diff >= 0.7) { factors.push({ l: "ã€å‚è€ƒã€‘è©•ç‚¹ä¹–é›¢", det: `Gãƒãƒƒãƒ—â˜…${d.gmap} vs é£Ÿã¹ãƒ­ã‚°${d.tabelog}ï¼ˆå·®${diff.toFixed(1)}ï¼‰`, w: 0 }); }
  }
  if (d.tabelog != null && d.tabelog <= 3.02) { factors.push({ l: "ã€å‚è€ƒã€‘é£Ÿã¹ãƒ­ã‚°ä½è©•ä¾¡", det: `${d.tabelog}`, w: 0 }); }
  if (d.gmapCount >= 500 && (d.tabelog == null || d.tabelog < 3.1)) {
    factors.push({ l: "ã€å‚è€ƒã€‘å£ã‚³ãƒŸæ•°ã®ç•°å¸¸", det: `Gãƒãƒƒãƒ—${d.gmapCount}ä»¶ Ã— é£Ÿã¹ãƒ­ã‚°${d.tabelog ?? "æœªæ²è¼‰"}`, w: 0 });
  }
  const maxScore = 10;
  const pct = Math.min(Math.round((score / maxScore) * 100), 100);
  const level = pct >= 70 ? "å±é™º" : pct >= 45 ? "è¦æ³¨æ„" : pct >= 25 ? "ã‚„ã‚„æ³¨æ„" : "ä½ãƒªã‚¹ã‚¯";
  const color = pct >= 70 ? "#DC2626" : pct >= 45 ? "#EA580C" : pct >= 25 ? "#CA8A04" : "#16A34A";
  return { score, pct, level, color, factors };
}

/* â”€â”€â”€ System Prompt â”€â”€â”€ */
const SYSTEM_PROMPT = `ã‚ãªãŸã¯é£²é£Ÿåº—ã®å®¢å¼•ããƒ»ã¼ã£ãŸãã‚Šãƒªã‚¹ã‚¯ã‚’èª¿æŸ»ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®æƒ…å ±ã‚’åé›†ã—ã€JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã¯ä¸è¦ã§ã™ã€‚

ã€å¿…é ˆæ¤œç´¢ã€‘
æ¤œç´¢1: ã€Œ(åº—å) ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã€â†’ ä½æ‰€ãƒ»éšæ•°ãƒ»é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹æœ€å®‰ä¾¡æ ¼ãƒ»åŒãƒ“ãƒ«å†…ã®åˆ¥åº—èˆ—ã‚’ç¢ºèª
æ¤œç´¢2: ã€Œ(åº—å) ã‚­ãƒ£ãƒƒãƒ ã¼ã£ãŸãã‚Š å£ã‚³ãƒŸã€â†’ ã‚­ãƒ£ãƒƒãƒãƒ»å®¢å¼•ããƒ»ã¼ã£ãŸãã‚Šã«é–¢ã™ã‚‹å£ã‚³ãƒŸã‚’æ¤œç´¢
æ¤œç´¢3: ã€Œ(åº—å) Googleãƒãƒƒãƒ— å£ã‚³ãƒŸ è©•ä¾¡ã€â†’ Gãƒãƒƒãƒ—ã®æ˜Ÿè©•ä¾¡ãƒ»å£ã‚³ãƒŸä»¶æ•°ã‚’å–å¾—

æ¤œç´¢çµæœã«é£Ÿã¹ãƒ­ã‚°ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãŸå ´åˆã¯ã€è©•ç‚¹ã¨å£ã‚³ãƒŸæ•°ã‚‚è¨˜éŒ²ã—ã¦ãã ã•ã„ï¼ˆå°‚ç”¨ã®æ¤œç´¢ã¯ä¸è¦ï¼‰ã€‚

å›ç­”ã¯JSONå½¢å¼ã®ã¿ã€‚

{
  "shopName": "æ­£å¼åº—å",
  "address": "ä½æ‰€ï¼ˆãƒ“ãƒ«åãƒ»éšæ•°ã‚’å«ã‚€ï¼‰",
  "floor": éšæ•°ã®æ•°å€¤ï¼ˆB1Fãªã‚‰-1ã€1Fãªã‚‰nullã€ä¸æ˜ãªã‚‰nullï¼‰,
  "tabelog": é£Ÿã¹ãƒ­ã‚°è©•ç‚¹ï¼ˆæ¤œç´¢çµæœã«å«ã¾ã‚Œã¦ã„ãŸå ´åˆã®ã¿ã€ãªã‘ã‚Œã°nullï¼‰,
  "tabelogCount": é£Ÿã¹ãƒ­ã‚°å£ã‚³ãƒŸä»¶æ•°ï¼ˆåŒä¸Šã€ãªã‘ã‚Œã°nullï¼‰,
  "gmap": Googleãƒãƒƒãƒ—æ˜Ÿè©•ä¾¡ï¼ˆæ•°å€¤ã€ä¸æ˜ãªã‚‰nullï¼‰,
  "gmapCount": Googleãƒãƒƒãƒ—å£ã‚³ãƒŸä»¶æ•°ï¼ˆæ•°å€¤ã€ä¸æ˜ãªã‚‰nullï¼‰,
  "cheapCourse": æœ€å®‰ã®é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹ä¾¡æ ¼ï¼ˆæ•°å€¤ã€ä¸æ˜ãªã‚‰nullï¼‰,
  "crownName": åº—åã«ã€Œå€‹å®¤ã€ã€Œå±…é…’å±‹ã€ã€Œå®Œå…¨å€‹å®¤ã€ç­‰ã®SEOå† èªãŒã‚ã‚‹ã‹ï¼ˆtrue/falseï¼‰,
  "sameAddress": åŒã˜ãƒ“ãƒ«ãƒ»ä½æ‰€ã«ã‚ã‚‹åˆ¥ã®é£²é£Ÿåº—åï¼ˆæ–‡å­—åˆ—ã€ãªã‘ã‚Œã°nullï¼‰,
  "catchKeywords": ã€Œã‚­ãƒ£ãƒƒãƒ/å®¢å¼•ã/ã¼ã£ãŸãã‚Š/rip-offã€é–¢é€£ã®å£ã‚³ãƒŸï¼ˆé…åˆ—ã€æœ€å¤§5ä»¶ï¼‰,
  "summary": ç‰¹è¨˜äº‹é …ï¼ˆ1ã€œ2æ–‡ï¼‰
}`;

/* â”€â”€â”€ Local Storage helpers â”€â”€â”€ */
const STORAGE_KEY = "catch-risk-results";

function loadSharedResults() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) return JSON.parse(data);
  } catch (e) { console.error("Load error:", e); }
  return [];
}

function saveSharedResults(results) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(results));
  } catch (e) { console.error("Save error:", e); }
}

/* â”€â”€â”€ Google Sheets Integration â”€â”€â”€ */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxnZEpb_L_nLHRx3Iwn4L-gWQG6c1qdseRf0-MrW8VLIdlI8ZZKSfMY0dImEnDA1wB0/exec";

function sendToSheet(result, riskData) {
  try {
    fetch(SHEET_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        timestamp: result.timestamp,
        shopName: result.shopName,
        area: result.area,
        address: result.address,
        floor: result.floor,
        tabelog: result.tabelog,
        tabelogCount: result.tabelogCount,
        gmap: result.gmap,
        gmapCount: result.gmapCount,
        cheapCourse: result.cheapCourse,
        crownName: result.crownName,
        sameAddress: result.sameAddress,
        catchKeywords: result.catchKeywords,
        riskPct: riskData.pct,
        riskLevel: riskData.level,
        riskFactors: riskData.factors.map(f => `${f.l}(+${f.w})`).join(", "),
        summary: result.summary
      })
    });
  } catch (e) { console.error("Sheet send error:", e); }
}


/* â”€â”€â”€ Tab Button â”€â”€â”€ */
function TabBtn({ active, children, onClick }) {
  return (
    <button onClick={onClick} style={{
      background: active ? "#1E293B" : "transparent",
      border: `1px solid ${active ? "#475569" : "#1E293B"}`,
      color: active ? "#F1F5F9" : "#475569",
      padding: "6px 18px", borderRadius: 20, fontSize: 13,
      cursor: "pointer", fontWeight: active ? 700 : 400,
      transition: "all 0.2s", fontFamily: "'Noto Sans JP', sans-serif"
    }}>{children}</button>
  );
}

/* â”€â”€â”€ Main App â”€â”€â”€ */
function LiveCatchRiskApp() {
  const [query, setQuery] = useState("");
  const [area, setArea] = useState("é‡‘æ²¢ç‰‡ç”ºã‚¨ãƒªã‚¢");
  const [apiKey, setApiKey] = useState(() => {
    try { return localStorage.getItem("catch-risk-apikey") || ""; } catch(e) { return ""; }
  });
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState("");
  const [results, setResults] = useState([]);
  const [expandedIdx, setExpandedIdx] = useState(null);
  const [error, setError] = useState(null);
  const [view, setView] = useState("cards");
  const [pendingResult, setPendingResult] = useState(null);
  const [showConfirm, setShowConfirm] = useState(false);

  useEffect(() => {
    setResults(loadSharedResults());
  }, []);


  async function doSearch() {
    if (!query.trim()) return;
    if (!apiKey.trim()) { setError("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç”»é¢ä¸Šéƒ¨ã®ğŸ”‘æ¬„ï¼‰"); return; }
    setLoading(true); setError(null); setPendingResult(null); setShowConfirm(false);
    setProgress("ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’å®Ÿè¡Œä¸­â€¦ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ»Googleãƒãƒƒãƒ—ãƒ»å£ã‚³ãƒŸã‚’èª¿æŸ»ã—ã¦ã„ã¾ã™");
    try {
      const resp = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey.trim(),
          "anthropic-version": "2023-06-01"
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          system: SYSTEM_PROMPT,
          messages: [{ role: "user", content: `ä»¥ä¸‹ã®åº—èˆ—ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„: ${query.trim()}${area.trim() ? `ï¼ˆã‚¨ãƒªã‚¢: ${area.trim()}ï¼‰` : ""}` }],
          tools: [{ type: "web_search_20250305", name: "web_search" }]
        })
      });
      const data = await resp.json();
      setProgress("ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­â€¦");
      const textBlocks = (data.content || []).filter(b => b.type === "text").map(b => b.text).join("\n");
      let parsed = null;
      try {
        const cleaned = textBlocks.replace(/```json|```/g, "").trim();
        const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
        if (jsonMatch) parsed = JSON.parse(jsonMatch[0]);
      } catch (e) { console.error("Parse error:", e, textBlocks); }
      if (parsed) {
        const now = new Date();
        const ts = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
        const result = {
          id: `${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
          query: query.trim(), area: area.trim(), shopName: parsed.shopName || query.trim(),
          address: parsed.address || "ä¸æ˜", floor: parsed.floor,
          tabelog: parsed.tabelog, tabelogCount: parsed.tabelogCount,
          gmap: parsed.gmap, gmapCount: parsed.gmapCount,
          cheapCourse: parsed.cheapCourse, crownName: parsed.crownName || false,
          sameAddress: parsed.sameAddress, catchKeywords: parsed.catchKeywords || [],
          summary: parsed.summary || "", timestamp: ts,
        };
        function mergeWithExisting(newResult, existingResults) {
          const idx = existingResults.findIndex(r =>
            r.shopName.replace(/\s/g, "") === newResult.shopName.replace(/\s/g, "")
          );
          if (idx === -1) return [newResult, ...existingResults];
          const old = existingResults[idx];
          const mergedKW = [...new Set([...(old.catchKeywords || []), ...(newResult.catchKeywords || [])])].slice(0, 10);
          const merged = { ...newResult, catchKeywords: mergedKW };
          const rest = existingResults.filter((_, i) => i !== idx);
          return [merged, ...rest];
        }
        const q = query.trim().toLowerCase();
        const sn = (parsed.shopName || "").toLowerCase();
        const isExactish = sn.includes(q) || q.includes(sn) || q.length >= 10;
        if (isExactish) {
          const updated = mergeWithExisting(result, results);
          setResults(updated);
          setExpandedIdx(0);
          setQuery("");
          saveSharedResults(updated);
          sendToSheet(result, calcFromData(result));
        } else {
          setPendingResult(result);
          setShowConfirm(true);
        }
      } else {
        setError("æ¤œç´¢çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åº—åã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }
    } catch (e) {
      console.error("Search error:", e);
      setError("æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    }
    setLoading(false); setProgress("");
  }

  function confirmResult(accept) {
    if (accept && pendingResult) {
      function mergeConfirm(newR, existing) {
        const idx = existing.findIndex(r => r.shopName.replace(/\s/g, "") === newR.shopName.replace(/\s/g, ""));
        if (idx === -1) return [newR, ...existing];
        const old = existing[idx];
        const mergedKW = [...new Set([...(old.catchKeywords || []), ...(newR.catchKeywords || [])])].slice(0, 10);
        const merged = { ...newR, catchKeywords: mergedKW };
        const rest = existing.filter((_, i) => i !== idx);
        return [merged, ...rest];
      }
      const updated = mergeConfirm(pendingResult, results);
      setResults(updated);
      setExpandedIdx(0);
      setQuery("");
      saveSharedResults(updated);
      sendToSheet(pendingResult, calcFromData(pendingResult));
    }
    setPendingResult(null);
    setShowConfirm(false);
  }


  const dangerCount = results.filter(r => calcFromData(r).pct >= 70).length;
  const cautionCount = results.filter(r => calcFromData(r).pct >= 45 && calcFromData(r).pct < 70).length;

  return (
    <div style={{
      minHeight: "100vh",
      background: "linear-gradient(180deg, #020617 0%, #0F172A 40%, #020617 100%)",
      color: "#F1F5F9", fontFamily: "'Noto Sans JP', sans-serif", padding: "0 0 60px"
    }}>
      {/* Header */}
      <div style={{
        padding: "36px 20px 28px",
        background: "linear-gradient(180deg, rgba(220,38,38,0.08) 0%, transparent 100%)",
        borderBottom: "1px solid #1E293B"
      }}>
        <div style={{ maxWidth: 960, margin: "0 auto" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 6 }}>
            <span style={{ fontSize: 26 }}>ğŸ”</span>
            <span style={{ background: "#DC2626", color: "#fff", padding: "3px 12px", borderRadius: 6, fontSize: 10, fontWeight: 700, letterSpacing: 1.5 }}>LIVE SEARCH</span>
          </div>
          <h1 style={{
            margin: 0, fontSize: 24, fontWeight: 800, lineHeight: 1.3,
            background: "linear-gradient(135deg, #F1F5F9 0%, #94A3B8 100%)",
            WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent"
          }}>é‡‘æ²¢ç‰‡ç”º ã‚­ãƒ£ãƒƒãƒå±…é…’å±‹æŒ‡æ•°</h1>
          <div>
            <p style={{ margin: "4px 0 0", fontSize: 13, color: "#64748B" }}>Catch Izakaya Risk Index â€” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç‰ˆ v0.7</p>
          </div>
          <p style={{ margin: "10px 0 0", fontSize: 11, color: "#475569", lineHeight: 1.8 }}>
            æœ¬ãƒ„ãƒ¼ãƒ«ã®èª¿æŸ»å¯¾è±¡ã¯ã€Œé…’é¡ã®æä¾›ã‚’ä¸»ã¨ã—ã€é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹é£²é£Ÿåº—ã€ï¼ˆå±…é…’å±‹å‹é£²é£Ÿåº—ï¼‰ã§ã™ã€‚
            åº—åã«ã€Œå±…é…’å±‹ã€ã‚’å«ã¾ãªã„æ¥­æ…‹ï¼ˆæµ·é®®ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒ»å€‹å®¤å’Œé£Ÿç­‰ï¼‰ã‚‚ã€ä¸Šè¨˜ã®è¦ä»¶ã‚’æº€ãŸã™å ´åˆã¯å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚
          </p>
        </div>
      </div>

      <div style={{ maxWidth: 960, margin: "0 auto", padding: "24px 20px 0" }}>
        {/* API Key Input */}
        {!apiKey.trim() && (
          <div style={{
            background: "#0F172A", border: "1px solid #CA8A04", borderRadius: 14, padding: "16px 20px", marginBottom: 16
          }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 8 }}>
              <span style={{ fontSize: 16 }}>ğŸ”‘</span>
              <span style={{ fontSize: 13, color: "#CA8A04", fontWeight: 700 }}>APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>
            </div>
            <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
              <input type="password" placeholder="sk-ant-api03-..."
                onChange={e => {
                  const v = e.target.value;
                  setApiKey(v);
                  try { localStorage.setItem("catch-risk-apikey", v); } catch(e) {}
                }}
                style={{ flex: 1, background: "#020617", border: "1px solid #1E293B", borderRadius: 10, padding: "10px 14px", color: "#F1F5F9", fontSize: 13, outline: "none", fontFamily: "monospace" }} />
            </div>
            <p style={{ margin: "8px 0 0", fontSize: 11, color: "#475569" }}>ã‚­ãƒ¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼ˆAnthropic APIã¸ã®é€šä¿¡ã®ã¿ã«ä½¿ç”¨ï¼‰</p>
          </div>
        )}
        {apiKey.trim() && (
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
            <span style={{ fontSize: 12, color: "#065F46", display: "flex", alignItems: "center", gap: 4 }}>ğŸ”‘ APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿</span>
            <button onClick={() => { setApiKey(""); try { localStorage.removeItem("catch-risk-apikey"); } catch(e) {} }} style={{
              background: "transparent", border: "none", color: "#475569", fontSize: 11, cursor: "pointer", textDecoration: "underline"
            }}>ã‚­ãƒ¼ã‚’å¤‰æ›´</button>
          </div>
        )}
        {/* Search Box */}
        <div style={{
          display: "flex", gap: 10, marginBottom: 12,
          background: "#0F172A", border: "1px solid #1E293B", borderRadius: 14, padding: 8, alignItems: "center",
          flexWrap: "wrap"
        }}>
          <input type="text" value={query} onChange={e => setQuery(e.target.value)}
            onKeyDown={e => e.key === "Enter" && !loading && doSearch()}
            placeholder="åº—åï¼ˆä¾‹ï¼šâ—‹â—‹å±…é…’å±‹ï¼‰" disabled={loading}
            style={{ flex: "2 1 180px", background: "transparent", border: "none", outline: "none", color: "#F1F5F9", fontSize: 15, padding: "10px 14px", fontFamily: "'Noto Sans JP', sans-serif", minWidth: 0 }} />
          <div style={{ width: 1, height: 24, background: "#1E293B", flexShrink: 0 }} />
          <input type="text" value={area} onChange={e => setArea(e.target.value)}
            onKeyDown={e => e.key === "Enter" && !loading && doSearch()}
            placeholder="ã‚¨ãƒªã‚¢ï¼ˆå¤‰æ›´å¯ï¼‰" disabled={loading}
            style={{ flex: "1 1 120px", background: "transparent", border: "none", outline: "none", color: "#94A3B8", fontSize: 14, padding: "10px 14px", fontFamily: "'Noto Sans JP', sans-serif", minWidth: 0 }} />
          <button onClick={doSearch} disabled={loading || !query.trim()} style={{
            background: loading ? "#1E293B" : "#DC2626", color: "#fff", border: "none",
            borderRadius: 10, padding: "10px 24px", fontSize: 14, fontWeight: 700,
            cursor: loading ? "wait" : "pointer", opacity: (!query.trim() && !loading) ? 0.4 : 1,
            transition: "all 0.2s", fontFamily: "'Noto Sans JP', sans-serif", whiteSpace: "nowrap"
          }}>{loading ? "æ¤œç´¢ä¸­â€¦" : "èª¿æŸ»é–‹å§‹"}</button>
        </div>

        {/* Privacy Notice */}
        <div style={{
          display: "flex", alignItems: "flex-start", gap: 8, marginBottom: 20,
          background: "#0F172A", border: "1px solid #1E293B", borderRadius: 10, padding: "10px 14px"
        }}>
          <span style={{ fontSize: 14, flexShrink: 0, marginTop: 1 }}>ğŸ”</span>
          <p style={{ margin: 0, fontSize: 11, color: "#64748B", lineHeight: 1.7 }}>
            æœ¬ãƒ„ãƒ¼ãƒ«ã¯å…¥åŠ›ã•ã‚ŒãŸåº—åãŠã‚ˆã³å…¬é–‹ã‚°ãƒ«ãƒ¡ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã—ãŸè©•ç‚¹ãƒ»å£ã‚³ãƒŸæƒ…å ±ã®ã¿ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚åˆ©ç”¨è€…ã®å€‹äººæƒ…å ±ã¯ä¸€åˆ‡åé›†ã•ã‚Œã¾ã›ã‚“ã€‚èª¿æŸ»çµæœã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•é›†ç´„ã•ã‚Œã¾ã™ã€‚
          </p>
        </div>

        {/* Loading search */}
        {loading && (
          <div style={{ background: "#0F172A", border: "1px solid #1E293B", borderRadius: 14, padding: "20px 24px", marginBottom: 20, textAlign: "center" }}>
            <div style={{ width: 40, height: 40, border: "3px solid #1E293B", borderTopColor: "#DC2626", borderRadius: "50%", margin: "0 auto 14px", animation: "spin 1s linear infinite" }} />
            <p style={{ color: "#94A3B8", fontSize: 13, margin: 0 }}>{progress}</p>
            <p style={{ color: "#475569", fontSize: 11, margin: "8px 0 0" }}>Googleãƒãƒƒãƒ—ãƒ»ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ»å£ã‚³ãƒŸã‚’æ¨ªæ–­æ¤œç´¢ã—ã¦ã„ã¾ã™ï¼ˆ10ã€œ20ç§’ï¼‰</p>
          </div>
        )}
        {error && <div style={{ background: "#1a0505", border: "1px solid #7F1D1D", borderRadius: 14, padding: "16px 20px", marginBottom: 20, color: "#FCA5A5", fontSize: 13 }}>{error}</div>}

        {/* View Toggle */}
        {results.length > 0 && (
          <div style={{ display: "flex", alignItems: "center", marginBottom: 16, flexWrap: "wrap", gap: 10 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
              <TabBtn active={view === "cards"} onClick={() => setView("cards")}>ã‚«ãƒ¼ãƒ‰è¡¨ç¤º</TabBtn>
              <TabBtn active={view === "table"} onClick={() => setView("table")}>ä¸€è¦§è¡¨ç¤º</TabBtn>
              <span style={{ fontSize: 12, color: "#475569", marginLeft: 8 }}>
                {results.length}åº—èˆ—èª¿æŸ»æ¸ˆ
                {dangerCount > 0 && <span style={{ color: "#DC2626", marginLeft: 6 }}>ï¼ˆå±é™º{dangerCount}ï¼‰</span>}
                {cautionCount > 0 && <span style={{ color: "#EA580C", marginLeft: 4 }}>ï¼ˆè¦æ³¨æ„{cautionCount}ï¼‰</span>}
              </span>
            </div>
          </div>
        )}

        {/* â•â•â• Card View â•â•â• */}
        {view === "cards" && results.map((r, idx) => {
          const risk = calcFromData(r);
          const expanded = expandedIdx === idx;
          return (
            <div key={r.id || idx} style={{
              background: risk.pct >= 70 ? "linear-gradient(135deg, #1a0505 0%, #0F172A 100%)" : risk.pct >= 45 ? "linear-gradient(135deg, #1a0f05 0%, #0F172A 100%)" : "linear-gradient(135deg, #0F172A 0%, #0F172A 100%)",
              border: `1px solid ${risk.pct >= 70 ? "#7F1D1D" : risk.pct >= 45 ? "#7C2D12" : "#1E293B"}`,
              borderRadius: 16, padding: "20px 24px", marginBottom: 12, transition: "all 0.3s",
              boxShadow: risk.pct >= 70 ? "0 0 30px rgba(220,38,38,0.15)" : "none"
            }}>
              <div style={{ display: "flex", alignItems: "center", gap: 20, cursor: "pointer" }} onClick={() => setExpandedIdx(expanded ? null : idx)}>
                <RiskMeter pct={risk.pct} color={risk.color} level={risk.level} size={window.innerWidth < 480 ? 80 : 120} />
                <div style={{ flex: 1, minWidth: 0 }}>
                    <h3 style={{ margin: 0, fontSize: window.innerWidth < 480 ? 14 : 17, fontWeight: 700, color: "#F1F5F9", lineHeight: 1.4 }}>{r.shopName}</h3>
                  </div>
                  <p style={{ margin: "4px 0 0", fontSize: 12, color: "#64748B", wordBreak: "break-all" }}>{r.address}{r.area ? <span style={{ marginLeft: 8, background: "#1E293B", color: "#94A3B8", padding: "2px 8px", borderRadius: 10, fontSize: 11 }}>{r.area}</span> : null}</p>
                  <div style={{ display: "flex", gap: 6, marginTop: 8, flexWrap: "wrap" }}>
                    {r.tabelog != null && <span style={{ background: r.tabelog < 3.1 ? "#7F1D1D" : "#1E293B", color: r.tabelog < 3.1 ? "#FCA5A5" : "#94A3B8", padding: "2px 8px", borderRadius: 20, fontSize: 11, fontWeight: 600 }}>é£Ÿã¹ãƒ­ã‚° {r.tabelog}</span>}
                    {r.gmap != null && <span style={{ background: "#1E293B", color: "#94A3B8", padding: "2px 8px", borderRadius: 20, fontSize: 11, fontWeight: 600 }}>Gãƒãƒƒãƒ— â˜…{r.gmap}</span>}
                    {r.cheapCourse != null && r.cheapCourse < 3300 && <span style={{ background: "#7C2D12", color: "#FDBA74", padding: "2px 8px", borderRadius: 20, fontSize: 11, fontWeight: 600 }}>é£²æ”¾{r.cheapCourse}å††</span>}
                  </div>
                  <p style={{ margin: "4px 0 0", fontSize: 10, color: "#334155" }}>{r.timestamp}</p>
                </div>
              </div>
              {expanded && (
                <div style={{ marginTop: 20, paddingTop: 16, borderTop: "1px solid #1E293B" }}>
                  {r.summary && <p style={{ background: "#1E293B", padding: "12px 16px", borderRadius: 10, fontSize: 13, color: "#CBD5E1", lineHeight: 1.7, margin: "0 0 16px" }}>{r.summary}</p>}
                  <h4 style={{ color: "#F1F5F9", fontSize: 14, margin: "0 0 12px" }}>ãƒªã‚¹ã‚¯è¦å› åˆ†æ</h4>
                  {risk.factors.length === 0 && <p style={{ color: "#64748B", fontSize: 13 }}>ç‰¹ç­†ã™ã¹ããƒªã‚¹ã‚¯è¦å› ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>}
                  {risk.factors.map((f, i) => (
                    <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 10, marginBottom: 8 }}>
                      <span style={{ background: f.w >= 3 ? "#DC2626" : f.w >= 2 ? "#EA580C" : f.w >= 1 ? "#CA8A04" : "#475569", color: "#fff", padding: "2px 8px", borderRadius: 6, fontSize: 11, fontWeight: 700, whiteSpace: "nowrap", minWidth: 28, textAlign: "center" }}>+{f.w}</span>
                      <div>
                        <span style={{ color: "#E2E8F0", fontSize: 13, fontWeight: 600 }}>{f.l}</span>
                        <span style={{ color: "#64748B", fontSize: 12, marginLeft: 8 }}>{f.det}</span>
                      </div>
                    </div>
                  ))}
                  {r.catchKeywords && r.catchKeywords.length > 0 && (
                    <div style={{ marginTop: 16 }}>
                      <h4 style={{ color: "#FCA5A5", fontSize: 13, margin: "0 0 8px" }}>å£ã‚³ãƒŸã‹ã‚‰æ¤œå‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h4>
                      {r.catchKeywords.map((q, i) => (
                        <div key={i} style={{ background: "#1E293B", borderLeft: "3px solid #DC2626", padding: "8px 12px", marginBottom: 6, borderRadius: "0 8px 8px 0", color: "#CBD5E1", fontSize: 12, fontStyle: "italic", lineHeight: 1.5 }}>ã€Œ{q}ã€</div>
                      ))}
                    </div>
                  )}
                  {r.sameAddress && <div style={{ marginTop: 12, background: "#1E293B", padding: "10px 14px", borderRadius: 10, fontSize: 12, color: "#FDBA74" }}>âš  åŒä½æ‰€ã®åˆ¥åº—èˆ—: {r.sameAddress}</div>}
                </div>
              )}
            </div>
          );
        })}

        {/* â•â•â• Table View â•â•â• */}
        {view === "table" && results.length > 0 && (
          <div style={{ overflowX: "auto", borderRadius: 14, border: "1px solid #1E293B" }}>
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12, fontFamily: "'Noto Sans JP', sans-serif" }}>
              <thead>
                <tr style={{ background: "#0F172A" }}>
                  {["No.", "åº—å", "ã‚¨ãƒªã‚¢", "éš", "Gãƒãƒƒãƒ—", "æœ€å®‰ã‚³ãƒ¼ã‚¹", "ã‚¹ã‚³ã‚¢", "åˆ¤å®š", "ã‚­ãƒ£ãƒƒãƒ"].map(h => (
                    <th key={h} style={{ padding: "10px 8px", color: "#94A3B8", fontWeight: 600, textAlign: "left", borderBottom: "1px solid #1E293B", whiteSpace: "nowrap", fontSize: 11 }}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {results.map((r, i) => {
                  const risk = calcFromData(r);
                  return (
                    <tr key={r.id || i} style={{ borderBottom: "1px solid #1E293B", background: i % 2 === 0 ? "transparent" : "rgba(15,23,42,0.5)" }}>
                      <td style={{ padding: "8px", color: "#64748B" }}>{i + 1}</td>
                      <td style={{ padding: "8px", color: "#F1F5F9", fontWeight: 600 }}>{r.shopName}</td>
                      <td style={{ padding: "8px", color: "#64748B", fontSize: 11 }}>{r.area || "-"}</td>
                      <td style={{ padding: "8px", color: r.floor >= 4 ? "#FCA5A5" : "#94A3B8" }}>{r.floor != null ? `${r.floor}F` : "-"}</td>
                      <td style={{ padding: "8px", color: "#94A3B8" }}>{r.gmap != null ? `â˜…${r.gmap}` : "-"}</td>
                      <td style={{ padding: "8px", color: r.cheapCourse != null && r.cheapCourse < 2000 ? "#FCA5A5" : "#94A3B8" }}>{r.cheapCourse != null ? `${r.cheapCourse}å††` : "-"}</td>
                      <td style={{ padding: "8px" }}>
                        <span style={{ background: risk.color, color: "#fff", padding: "2px 10px", borderRadius: 10, fontWeight: 700, fontSize: 12, fontFamily: "'DM Mono', monospace" }}>{risk.pct}</span>
                      </td>
                      <td style={{ padding: "8px", color: risk.color, fontWeight: 700, fontSize: 12 }}>{risk.level}</td>
                      <td style={{ padding: "8px", color: r.catchKeywords.length > 0 ? "#FCA5A5" : "#334155" }}>
                        {r.catchKeywords.length > 0 ? `${r.catchKeywords.length}ä»¶` : "-"}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}

        {/* Empty state */}
        {results.length === 0 && !loading && (
          <div style={{ textAlign: "center", padding: "48px 20px", color: "#334155" }}>
            <div style={{ fontSize: 48, marginBottom: 16 }}>ğŸ®</div>
            <p style={{ fontSize: 14, lineHeight: 1.7 }}>
              ä¸Šã®æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«å±…é…’å±‹ã®åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br />
              Googleãƒãƒƒãƒ—ãƒ»ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ»å£ã‚³ãƒŸã‚’è‡ªå‹•æ¤œç´¢ã—ã€<br />
              ã‚­ãƒ£ãƒƒãƒå±…é…’å±‹ã®å¯èƒ½æ€§ã‚’åˆ¤å®šã—ã¾ã™ã€‚
            </p>
            <p style={{ fontSize: 13, color: "#475569", marginTop: 16, lineHeight: 1.7 }}>
              èª¿æŸ»çµæœã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br />
              ç®¡ç†è€…ã®ã¿ã€ŒExcelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§ä¸€æ‹¬å‡ºåŠ›ã§ãã¾ã™ã€‚
            </p>
          </div>
        )}

        {/* Legend */}
        <div style={{ marginTop: 32, background: "#0F172A", border: "1px solid #1E293B", borderRadius: 16, padding: "20px 24px" }}>
          <h4 style={{ margin: "0 0 14px", fontSize: 14, color: "#F1F5F9", fontWeight: 700 }}>ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°åŸºæº–</h4>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "6px 16px", fontSize: 11, color: "#94A3B8", lineHeight: 1.8 }}>
            <div>â€¢ æ‰€åœ¨éš4Fä»¥ä¸Š â†’ +2 / 2-3F â†’ +1</div>
            <div>â€¢ é£²æ”¾ä»˜2,000å††æœªæº€ â†’ +2 / 3,300å††æœªæº€ â†’ +1</div>
            <div>â€¢ å£ã‚³ãƒŸã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€3ä»¶è¶… â†’ +3</div>
            <div>â€¢ å£ã‚³ãƒŸã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€1-2ä»¶ â†’ +2</div>
            <div>â€¢ åŒä½æ‰€ã«åˆ¥åº—èˆ— â†’ +1</div>
            <div>â€¢ SEOçš„å† èªï¼ˆå€‹å®¤/å®Œå…¨å€‹å®¤ç­‰ï¼‰â†’ +1</div>
            <div>â€¢ Gãƒãƒƒãƒ—â˜…3.5ä»¥ä¸‹ â†’ +1</div>
            <div style={{ color: "#475569" }}>â€» é£Ÿã¹ãƒ­ã‚°è©•ç‚¹ã¯å‚è€ƒè¡¨ç¤ºï¼ˆã‚¹ã‚³ã‚¢éåŠ ç®—ï¼‰</div>
          </div>
          <div style={{ marginTop: 14, display: "flex", gap: 14, fontSize: 11, flexWrap: "wrap" }}>
            <span><span style={{ color: "#DC2626", fontWeight: 700 }}>â–  70ã€œ100</span> å±é™º</span>
            <span><span style={{ color: "#EA580C", fontWeight: 700 }}>â–  45ã€œ69</span> è¦æ³¨æ„</span>
            <span><span style={{ color: "#CA8A04", fontWeight: 700 }}>â–  25ã€œ44</span> ã‚„ã‚„æ³¨æ„</span>
            <span><span style={{ color: "#16A34A", fontWeight: 700 }}>â–  0ã€œ24</span> ä½ãƒªã‚¹ã‚¯</span>
          </div>
        </div>

        <div style={{ marginTop: 24, textAlign: "center", fontSize: 11, color: "#334155", lineHeight: 1.8 }}>
          <p>é‡‘æ²¢å¸‚ç‰‡ç”º å®¢å¼•ãå•é¡Œèª¿æŸ» â”€ åŒ—é™¸å¤§å­¦ å±±æœ¬ç ”ç©¶å®¤</p>
          <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ç‰ˆ v0.7 â”€ èª¿æŸ»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå‚è€ƒæŒ‡æ¨™ã§ã™</p>
        </div>
      </div>

      {/* Confirmation Dialog */}
      {showConfirm && pendingResult && (
        <div style={{
          position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)",
          display: "flex", alignItems: "center", justifyContent: "center", zIndex: 9998, padding: 20
        }} onClick={() => confirmResult(false)}>
          <div onClick={e => e.stopPropagation()} style={{
            background: "#0F172A", border: "1px solid #1E293B", borderRadius: 16,
            padding: "32px 28px", maxWidth: 380, width: "100%", boxShadow: "0 20px 60px rgba(0,0,0,0.5)"
          }}>
            <h3 style={{ margin: "0 0 6px", fontSize: 16, color: "#F1F5F9", fontWeight: 700 }}>ğŸ” åº—èˆ—ã®ç¢ºèª</h3>
            <p style={{ margin: "0 0 16px", fontSize: 12, color: "#64748B" }}>
              æ¤œç´¢èªã€Œ{pendingResult.query}ã€ã«å¯¾ã—ã¦ä»¥ä¸‹ã®åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã®åº—èˆ—ã§åˆã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
            </p>
            <div style={{ background: "#020617", border: "1px solid #1E293B", borderRadius: 12, padding: "16px", marginBottom: 20 }}>
              <p style={{ margin: "0 0 6px", fontSize: 15, color: "#F1F5F9", fontWeight: 700 }}>{pendingResult.shopName}</p>
              <p style={{ margin: "0 0 4px", fontSize: 12, color: "#94A3B8" }}>ğŸ“ {pendingResult.address}</p>
              {pendingResult.gmap != null && <p style={{ margin: "0", fontSize: 12, color: "#94A3B8" }}>â­ Gãƒãƒƒãƒ— â˜…{pendingResult.gmap}</p>}
            </div>
            <div style={{ display: "flex", gap: 10 }}>
              <button onClick={() => confirmResult(false)} style={{
                flex: 1, background: "#1E293B", color: "#94A3B8", border: "none",
                borderRadius: 10, padding: "12px", fontSize: 13, cursor: "pointer",
                fontFamily: "'Noto Sans JP', sans-serif"
              }}>é•ã†åº—èˆ—ã§ã™</button>
              <button onClick={() => confirmResult(true)} style={{
                flex: 1, background: "#2563EB", color: "#fff", border: "none",
                borderRadius: 10, padding: "12px", fontSize: 13, fontWeight: 700, cursor: "pointer",
                fontFamily: "'Noto Sans JP', sans-serif"
              }}>åˆã£ã¦ã„ã¾ã™</button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}

ReactDOM.render(<LiveCatchRiskApp />, document.getElementById("root"));
</script>
</body>
</html>
