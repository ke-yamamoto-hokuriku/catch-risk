<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é‡‘æ²¢ç‰‡ç”º é£²é£Ÿåº— é¡§å®¢æº€è¶³åº¦èª¿æŸ»</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:linear-gradient(180deg,#E2E8F0 0%,#F1F5F9 40%,#E2E8F0 100%);
  color:#1E293B;font-family:'Noto Sans JP',sans-serif;min-height:100vh
}
@keyframes spin{to{transform:rotate(360deg)}}
.wrap{max-width:960px;margin:0 auto;padding:24px 20px 0}
.header{
  padding:36px 20px 28px;
  background:linear-gradient(180deg,rgba(37,99,235,0.12) 0%,transparent 100%);
  border-bottom:1px solid #CBD5E1
}
.header-inner{max-width:960px;margin:0 auto}
h1{
  font-size:24px;font-weight:800;line-height:1.3;margin:0;
  background:linear-gradient(135deg,#1E293B 0%,#475569 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent
}
.subtitle-row{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.subtitle{margin:4px 0 0;font-size:13px;color:#64748B}
.definition{margin:10px 0 0;font-size:11px;color:#475569;line-height:1.8}
.badge{background:#2563EB;color:#fff;padding:3px 12px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:1.5px}
.apibox{background:#FFFFFF;border:1px solid #CA8A04;border-radius:14px;padding:16px 20px;margin-bottom:16px}
.apibox input{width:100%;background:#F8FAFC;border:1px solid #CBD5E1;border-radius:10px;padding:10px 14px;color:#1E293B;font-size:13px;outline:none;font-family:monospace;margin-top:8px;box-sizing:border-box}
.api-ok{font-size:12px;color:#065F46;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.api-ok button{background:none;border:none;color:#475569;font-size:11px;cursor:pointer;text-decoration:underline}
.searchbox{
  display:flex;gap:10px;margin-bottom:12px;
  background:#FFFFFF;border:1px solid #CBD5E1;border-radius:14px;padding:8px;align-items:center;flex-wrap:wrap
}
.searchbox input{background:transparent;border:none;outline:none;color:#1E293B;font-size:15px;padding:10px 14px;font-family:'Noto Sans JP',sans-serif;min-width:0}
.q-input{flex:2 1 180px}
.a-input{flex:1 1 120px;color:#94A3B8 !important;font-size:14px !important}
.divider{width:1px;height:24px;background:#CBD5E1;flex-shrink:0}
.btn-search{background:#DC2626;color:#fff;border:none;border-radius:10px;padding:10px 24px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans JP',sans-serif;white-space:nowrap}
.btn-search:disabled{background:#94A3B8;cursor:wait;opacity:0.7}
.privacy{
  display:flex;align-items:flex-start;gap:8px;margin-bottom:20px;
  background:#F8FAFC;border:1px solid #CBD5E1;border-radius:10px;padding:10px 14px
}
.privacy p{font-size:11px;color:#64748B;line-height:1.7;margin:0}
.loading{background:#FFFFFF;border:1px solid #CBD5E1;border-radius:14px;padding:20px 24px;margin-bottom:20px;text-align:center}
.spinner{width:40px;height:40px;border:3px solid #CBD5E1;border-top-color:#DC2626;border-radius:50%;margin:0 auto 14px;animation:spin 1s linear infinite}
.error-box{background:#FEF2F2;border:1px solid #FECACA;border-radius:14px;padding:16px 20px;margin-bottom:20px;color:#DC2626;font-size:13px}
.card{border-radius:16px;padding:20px 24px;margin-bottom:12px;transition:all 0.3s;cursor:pointer}
.card-header{display:flex;align-items:center;gap:20px}
.card h3{font-size:17px;font-weight:700;color:#1E293B;line-height:1.4;margin:0}
.card .addr{margin:4px 0 0;font-size:13px;color:#64748B;word-break:break-all}
.tags{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.tag{padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block}
.ts{margin:6px 0 0;font-size:11px;color:#94A3B8}
.detail{margin-top:20px;padding-top:16px;border-top:1px solid #CBD5E1}
.summary-box{background:#F1F5F9;padding:12px 16px;border-radius:10px;font-size:13px;color:#475569;line-height:1.7;margin:0 0 16px}
.factor{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px}
.fw{padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;white-space:nowrap;min-width:28px;text-align:center;color:#fff}
.kw-item{background:#1E293B;border-left:3px solid #DC2626;padding:8px 12px;margin-bottom:6px;border-radius:0 8px 8px 0;color:#CBD5E1;font-size:12px;font-style:italic;line-height:1.5}
.meter{position:relative;flex-shrink:0}
.meter-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.legend{margin-top:32px;background:#FFFFFF;border:1px solid #CBD5E1;border-radius:16px;padding:20px 24px}
.legend h4{margin:0 0 14px;font-size:14px;color:#1E293B;font-weight:700}
.legend-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;font-size:11px;color:#94A3B8;line-height:1.8}
.legend-levels{margin-top:14px;display:flex;gap:14px;font-size:11px;flex-wrap:wrap}
.footer{margin-top:24px;text-align:center;font-size:11px;color:#94A3B8;line-height:1.8;padding-bottom:60px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9998;padding:20px}
.modal{background:#FFFFFF;border:1px solid #CBD5E1;border-radius:16px;padding:32px 28px;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.modal h3{margin:0 0 6px;font-size:16px;color:#1E293B;font-weight:700}
.modal-detail{background:#F1F5F9;border:1px solid #CBD5E1;border-radius:12px;padding:16px;margin-bottom:20px}
.modal-btns{display:flex;gap:10px}
.modal-btns button{flex:1;border:none;border-radius:10px;padding:12px;font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
.area-badge{margin-left:8px;background:#1E293B;color:#94A3B8;padding:2px 8px;border-radius:10px;font-size:11px;display:inline-block}
.stats{font-size:12px;color:#475569}
.empty{text-align:center;padding:48px 20px;color:#334155}
.hidden{display:none}
.tab-btn{border-radius:20px;font-size:13px;padding:6px 18px;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans JP',sans-serif}
.tab-btn.active{background:#FFFFFF;border:1px solid #94A3B8;color:#1E293B;font-weight:700}
.tab-btn.inactive{background:transparent;border:1px solid #CBD5E1;color:#64748B;font-weight:400}
.btn-admin{
  background:transparent;border:1px solid #CBD5E1;border-radius:8px;
  color:#475569;font-size:12px;padding:4px 12px;cursor:pointer;
  display:inline-flex;align-items:center;gap:4px;font-family:'Noto Sans JP',sans-serif
}
.btn-export{
  background:linear-gradient(135deg,#065F46 0%,#047857 100%);
  color:#fff;border:none;border-radius:10px;
  padding:8px 20px;font-size:13px;font-weight:700;
  cursor:pointer;font-family:'Noto Sans JP',sans-serif;
  display:inline-flex;align-items:center;gap:6px;transition:all 0.2s
}
.btn-remove{background:transparent;border:none;color:#334155;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;flex-shrink:0}
.view-toggle{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.view-left{display:flex;align-items:center;gap:8px}
.data-table{width:100%;border-collapse:collapse;font-size:12px;font-family:'Noto Sans JP',sans-serif}
.data-table th{padding:10px 8px;color:#64748B;font-weight:600;text-align:left;border-bottom:1px solid #CBD5E1;white-space:nowrap;font-size:11px}
.data-table td{padding:8px}
.data-table thead tr{background:#E2E8F0}
.data-table tbody tr{border-bottom:1px solid #CBD5E1}
.data-table tbody tr:nth-child(even){background:rgba(241,245,249,0.5)}
@media(max-width:480px){
  .card h3{font-size:14px}
  .legend-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <span style="font-size:26px">ğŸ”</span>
      <span class="badge">LIVE SEARCH</span>
    </div>
    <h1>é‡‘æ²¢ç‰‡ç”º é£²é£Ÿåº— é¡§å®¢æº€è¶³åº¦èª¿æŸ»</h1>
    <div class="subtitle-row">
      <p class="subtitle">Customer Satisfaction Survey â€” v0.8</p>
      <div id="adminArea"></div>
    </div>
    <p class="definition">èª¿æŸ»å¯¾è±¡ï¼šé…’é¡ã®æä¾›ã‚’ä¸»ã¨ã—ã€é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹é£²é£Ÿåº—ï¼ˆå±…é…’å±‹å‹é£²é£Ÿåº—ï¼‰ã€‚ã€Œç‰‡ç”ºã‚¨ãƒªã‚¢ã€ã¯ç‰‡ç”º1ã€œ2ä¸ç›®ã€æœ¨å€‰ç”ºã€æŸ¿æœ¨ç• ã€æ–°å¤©åœ°ã‚’å«ã‚€ç¹è¯è¡—ä¸€å¸¯ã‚’æŒ‡ã—ã¾ã™ã€‚</p>
  </div>
</div>

<div class="wrap">
  <div id="apiSection"></div>

  <div class="searchbox">
    <input type="text" id="queryInput" class="q-input" placeholder="åº—åï¼ˆä¾‹ï¼šâ—‹â—‹å±…é…’å±‹ï¼‰">
    <div class="divider"></div>
    <input type="text" id="areaInput" class="a-input" placeholder="ã‚¨ãƒªã‚¢ï¼ˆå¤‰æ›´å¯ï¼‰" value="é‡‘æ²¢ç‰‡ç”ºã‚¨ãƒªã‚¢">
    <button class="btn-search" id="searchBtn">èª¿æŸ»é–‹å§‹</button>
  </div>

  <div class="privacy">
    <span style="font-size:14px;flex-shrink:0;margin-top:1px">ğŸ”</span>
    <p>æœ¬ãƒ„ãƒ¼ãƒ«ã¯å…¥åŠ›ã•ã‚ŒãŸåº—åãŠã‚ˆã³å…¬é–‹ã‚°ãƒ«ãƒ¡ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã—ãŸè©•ç‚¹ãƒ»å£ã‚³ãƒŸæƒ…å ±ã®ã¿ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚åˆ©ç”¨è€…ã®å€‹äººæƒ…å ±ï¼ˆæ°åãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãƒ»ä½ç½®æƒ…å ±ç­‰ï¼‰ã¯ä¸€åˆ‡åé›†ãƒ»è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚èª¿æŸ»çµæœã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•é›†ç´„ã•ã‚Œã¾ã™ã€‚</p>
  </div>

  <div id="loadingArea" class="hidden"></div>
  <div id="errorArea" class="hidden"></div>
  <div id="viewToggleArea" class="hidden"></div>
  <div id="resultsArea"></div>
  <div id="emptyState"></div>

  <div class="legend">
    <h4>æº€è¶³åº¦ã®åˆ¤å®šåŸºæº–</h4>
    <div class="legend-grid">
      <div>â€¢ æ‰€åœ¨éš4Fä»¥ä¸Š â†’ âˆ’2 / 2-3F â†’ âˆ’1</div>
      <div>â€¢ é£²æ”¾ä»˜2,000å††æœªæº€ â†’ âˆ’2 / 3,300å††æœªæº€ â†’ âˆ’1</div>
      <div>â€¢ ãƒã‚¬ãƒ†ã‚£ãƒ–å£ã‚³ãƒŸ3ä»¶è¶… â†’ âˆ’3</div>
      <div>â€¢ ãƒã‚¬ãƒ†ã‚£ãƒ–å£ã‚³ãƒŸ1-2ä»¶ â†’ âˆ’2</div>
      <div>â€¢ SEOçš„å† èªï¼ˆå€‹å®¤/å®Œå…¨å€‹å®¤ç­‰ï¼‰â†’ âˆ’1</div>
      <div>â€¢ Gãƒãƒƒãƒ—è©•ä¾¡â˜…3.5ä»¥ä¸‹ â†’ âˆ’2</div>
      <div style="color:#475569">â€» é£Ÿã¹ãƒ­ã‚°è©•ç‚¹ã¯å‚è€ƒè¡¨ç¤º</div>
    </div>
    <div class="legend-levels">
      <span><span style="color:#16A34A;font-weight:700">â–  76ã€œ100</span> é«˜æº€è¶³</span>
      <span><span style="color:#CA8A04;font-weight:700">â–  56ã€œ75</span> æ™®é€š</span>
      <span><span style="color:#EA580C;font-weight:700">â–  31ã€œ55</span> ã‚„ã‚„ä¸æº€</span>
      <span><span style="color:#DC2626;font-weight:700">â–  0ã€œ30</span> ä½æº€è¶³</span>
    </div>
  </div>

  <div class="footer">
    <p>é‡‘æ²¢å¸‚ç‰‡ç”º é£²é£Ÿåº—é¡§å®¢æº€è¶³åº¦èª¿æŸ» â”€ åŒ—é™¸å¤§å­¦ å±±æœ¬ç ”ç©¶å®¤</p>
    <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ç‰ˆ v0.8 â”€ èª¿æŸ»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå‚è€ƒæŒ‡æ¨™ã§ã™</p>
  </div>
</div>

<div id="confirmOverlay" class="overlay hidden"></div>
<div id="pwOverlay" class="overlay hidden"></div>

<script>
/* â”€â”€ Config â”€â”€ */
var SHEET_URL = "https://script.google.com/macros/s/AKfycbxnZEpb_L_nLHRx3Iwn4L-gWQG6c1qdseRf0-MrW8VLIdlI8ZZKSfMY0dImEnDA1wB0/exec";

var SYSTEM_PROMPT = `ã‚ãªãŸã¯é£²é£Ÿåº—ã®å®¢å¼•ããƒ»ã¼ã£ãŸãã‚Šãƒªã‚¹ã‚¯ã‚’èª¿æŸ»ã™ã‚‹å°‚é–€ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’ä½¿ã£ã¦æƒ…å ±ã‚’åé›†ã—ã€JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆä¸è¦ã€‚HTMLã‚¿ã‚°ï¼ˆ<cite>ç­‰ï¼‰ã¯çµ¶å¯¾ã«å«ã‚ãªã„ã“ã¨ã€‚

ã€æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
- å¿…ãšä»¥ä¸‹ã®æ¤œç´¢ã‚’é †ç•ªã«ã™ã¹ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã€‚æ¤œç´¢ã®çœç•¥ã¯ç¦æ­¢ã€‚
- Googleãƒãƒƒãƒ—ã®â˜…è©•ä¾¡ã®å–å¾—ã¨ã‚­ãƒ£ãƒƒãƒé–¢é€£å£ã‚³ãƒŸã®å–å¾—ãŒæœ€ã‚‚é‡è¦ã€‚
- summaryã«æ›¸ãå†…å®¹ã¨JSONãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å†…å®¹ã¯å¿…ãšä¸€è‡´ã•ã›ã‚‹ã“ã¨ã€‚
  ä¾‹ï¼šsummaryã«ã€Œã‚­ãƒ£ãƒƒãƒã®å ±å‘Šã‚ã‚Šã€ã¨æ›¸ããªã‚‰ã€catchKeywordsã«ã‚‚å¿…ãšè©²å½“å£ã‚³ãƒŸã‚’å…¥ã‚Œã‚‹ã€‚

ã€å¿…é ˆæ¤œç´¢ï¼ˆã™ã¹ã¦å®Ÿè¡Œã›ã‚ˆï¼‰ã€‘

æ¤œç´¢1: ã€Œ(åº—å) ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã€
â†’ å–å¾—: æ­£å¼åº—åã€ä½æ‰€ï¼ˆãƒ“ãƒ«åå«ã‚€ï¼‰ã€éšæ•°ã€é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹æœ€å®‰ä¾¡æ ¼

æ¤œç´¢2: ã€Œ(åº—å) Google å£ã‚³ãƒŸ æ˜Ÿã€
â†’ å–å¾—: Googleãƒãƒƒãƒ—ã®â˜…è©•ä¾¡ï¼ˆæ•°å€¤ï¼‰ã¨Googleãƒãƒƒãƒ—ã®å£ã‚³ãƒŸä»¶æ•°ï¼ˆæ•°å€¤ï¼‰
â†’ ã€Œâ˜…2.17ï¼ˆ13ä»¶ï¼‰ã€ã®ã‚ˆã†ãªå½¢å¼ã§è¦‹ã¤ã‹ã‚‹ã“ã¨ãŒå¤šã„
â†’ ã‚‚ã—çµæœã«å«ã¾ã‚Œãªã‘ã‚Œã°ã€Œ(åº—å) é‡‘æ²¢ Google Maps ratingã€ã§ã‚‚è©¦ã™
â†’ gmapãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¿…ãšæ•°å€¤ã‚’å…¥ã‚Œã‚‹ã“ã¨ã€‚æœ¬å½“ã«è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã¿nullã€‚

æ¤œç´¢3: ã€Œ(åº—å) ã‚­ãƒ£ãƒƒãƒ ã¼ã£ãŸãã‚Šã€
â†’ å–å¾—: ã‚­ãƒ£ãƒƒãƒãƒ»å®¢å¼•ããƒ»ã¼ã£ãŸãã‚Šã«é–¢ã™ã‚‹å£ã‚³ãƒŸæ–‡
â†’ ä»¥ä¸‹ã®ã‚ˆã†ãªæ–‡è¨€ã‚’å«ã‚€å£ã‚³ãƒŸã‚’æ¢ã™ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªãƒ»ä¸­å›½èªï¼‰:
  æ—¥æœ¬èª: ã€Œã‚­ãƒ£ãƒƒãƒã«é€£ã‚Œã‚‰ã‚ŒãŸã€ã€Œå®¢å¼•ãã«å£°ã‚’ã‹ã‘ã‚‰ã‚ŒãŸã€ã€Œã¼ã£ãŸãã‚Šã€
  ã€Œã‚­ãƒ£ãƒƒãƒã®ãŠå…„ã•ã‚“ã€ã€Œå‘¼ã³è¾¼ã¿ã€ã€Œå‹§èª˜ã•ã‚ŒãŸã€ã€Œå‘¼ã³è¾¼ã¿ã•ã‚Œã€
  è‹±èª: "rip-off" "scam" "tout" "overpriced" "tourist trap" "dragged in" "street tout"
  ä¸­å›½èª: "å®°å®¢" "æ‹‰å®¢" "éª—äºº" "é»‘åº—" "å‘äºº" "è¢«æ‹‰è¿›å»" "æ‹‰å®¢çš„"
â†’ è¦‹ã¤ã‹ã£ãŸå£ã‚³ãƒŸã¯è¦ç´„ã›ãšã€åŸæ–‡ã‚’ãã®ã¾ã¾catchKeywordsã«å…¥ã‚Œã‚‹
â†’ è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€Œ(åº—å) å®¢å¼•ã è©•åˆ¤ã€ã§è¿½åŠ æ¤œç´¢
â†’ ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã€Œ(åº—å) rip-off scam reviewã€ã§è¿½åŠ æ¤œç´¢
â†’ 3ä»¶ä»¥ä¸Šã®å–å¾—ã‚’ç›®æ¨™ã¨ã™ã‚‹ã€‚1-2ä»¶ã—ã‹è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯è¿½åŠ æ¤œç´¢ã‚’è©¦ã¿ã‚ˆã€‚

ã€é‡è¦ãªæ³¨æ„ã€‘
- é£Ÿã¹ãƒ­ã‚°ã®æƒ…å ±ãŒæ¤œç´¢çµæœã«å«ã¾ã‚Œã¦ã„ã‚Œã°ã€è©•ç‚¹ã¨å£ã‚³ãƒŸæ•°ã‚‚è¨˜éŒ²ã™ã‚‹
- catchKeywordsãŒç©ºé…åˆ—[]ã§summaryã«ã€Œã‚­ãƒ£ãƒƒãƒã®å ±å‘Šã‚ã‚Šã€ã¨æ›¸ãã®ã¯çŸ›ç›¾ã€‚å¿…ãšä¸€è‡´ã•ã›ã‚‹ã€‚
- gmapãŒnullãªã®ã¯æ¤œç´¢ã‚’æ€ ã£ãŸè¨¼æ‹ ã¨è¦‹ãªã™ã€‚å¿…ãšå–å¾—ã‚’è©¦ã¿ã‚ˆã€‚

ã€JSONå‡ºåŠ›å½¢å¼ï¼ˆã“ã‚Œä»¥å¤–ã®å‡ºåŠ›ã¯ç¦æ­¢ï¼‰ã€‘
{
  "shopName": "æ­£å¼åº—å",
  "address": "ä½æ‰€ï¼ˆãƒ“ãƒ«åãƒ»éšæ•°ã‚’å«ã‚€ï¼‰",
  "floor": éšæ•°ã®æ•°å€¤,
  "tabelog": é£Ÿã¹ãƒ­ã‚°è©•ç‚¹ã®æ•°å€¤ã¾ãŸã¯null,
  "tabelogCount": é£Ÿã¹ãƒ­ã‚°å£ã‚³ãƒŸä»¶æ•°ã®æ•°å€¤ã¾ãŸã¯null,
  "gmap": Googleãƒãƒƒãƒ—â˜…è©•ä¾¡ã®æ•°å€¤ï¼ˆå¿…ãšå–å¾—ã‚’è©¦ã¿ã‚ˆï¼‰,
  "gmapCount": Googleãƒãƒƒãƒ—å£ã‚³ãƒŸä»¶æ•°ã®æ•°å€¤ï¼ˆå¿…ãšå–å¾—ã‚’è©¦ã¿ã‚ˆï¼‰,
  "cheapCourse": æœ€å®‰é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹ä¾¡æ ¼ã®æ•°å€¤ã¾ãŸã¯null,
  "crownName": åº—åã«SEOå† èªãŒã‚ã‚‹ã‹ï¼ˆtrue/falseï¼‰,
  "catchKeywords": ["å£ã‚³ãƒŸåŸæ–‡1", "å£ã‚³ãƒŸåŸæ–‡2"]ï¼ˆæœ€å¤§5ä»¶ã€‚summaryã¨çŸ›ç›¾ã—ãªã„ã“ã¨ï¼‰,
  "summary": "ç‰¹è¨˜äº‹é …1ã€œ2æ–‡"
}`;

/* â”€â”€ State â”€â”€ */
var results = [];
var expandedIdx = null;
var pendingResult = null;
var apiKey = "";
var isAdmin = false;
var currentView = "cards";
var ADMIN_PW = "mma";
try { apiKey = localStorage.getItem("catch-risk-apikey") || ""; } catch(e) {}
try { var saved = localStorage.getItem("catch-risk-results"); if (saved) results = JSON.parse(saved); } catch(e) {}

/* â”€â”€ Score Calculation â”€â”€ */
function calcFromData(d) {
  var factors = [], score = 0;
  if (d.floor != null && d.floor >= 4) { factors.push({l:"ç©ºä¸­éšï¼ˆé«˜å±¤ï¼‰",det:d.floor+"F",w:2}); score+=2; }
  else if (d.floor != null && d.floor >= 2) { factors.push({l:"ç©ºä¸­éš",det:d.floor+"F",w:1}); score+=1; }
  if (d.cheapCourse != null && d.cheapCourse < 2000) { factors.push({l:"éç¾å®Ÿçš„ä½ä¾¡æ ¼",det:"é£²æ”¾ä»˜"+d.cheapCourse+"å††",w:2}); score+=2; }
  else if (d.cheapCourse != null && d.cheapCourse < 3300) { factors.push({l:"ä½ä¾¡æ ¼ã‚³ãƒ¼ã‚¹",det:d.cheapCourse+"å††",w:1}); score+=1; }
  if (d.catchKeywords && d.catchKeywords.length >= 3) { factors.push({l:"ã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€å¤šæ•°",det:d.catchKeywords.length+"ä»¶æ¤œå‡º",w:3}); score+=3; }
  else if (d.catchKeywords && d.catchKeywords.length > 0) { factors.push({l:"ã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€æ¤œå‡º",det:d.catchKeywords.length+"ä»¶",w:2}); score+=2; }
  if (d.crownName) { factors.push({l:"SEOçš„å† èªãƒ‘ã‚¿ãƒ¼ãƒ³",det:"ã€Œå€‹å®¤ã€ã€Œå®Œå…¨å€‹å®¤ã€ç­‰ã‚’åº—åã«ä½¿ç”¨",w:1}); score+=1; }
  if (d.gmap != null && d.gmap <= 3.5) { factors.push({l:"Gãƒãƒƒãƒ—è©•ä¾¡",det:"â˜…"+d.gmap,w:2}); score+=2; }
  if (d.tabelog != null && d.gmap != null && (d.gmap-d.tabelog)>=0.7) {
    factors.push({l:"ã€å‚è€ƒã€‘è©•ç‚¹ä¹–é›¢",det:"Gãƒãƒƒãƒ—â˜…"+d.gmap+" vs é£Ÿã¹ãƒ­ã‚°"+d.tabelog+"ï¼ˆå·®"+(d.gmap-d.tabelog).toFixed(1)+"ï¼‰",w:0});
  }
  if (d.tabelog != null && d.tabelog <= 3.02) { factors.push({l:"ã€å‚è€ƒã€‘é£Ÿã¹ãƒ­ã‚°ä½è©•ä¾¡",det:""+d.tabelog,w:0}); }
  if (d.gmapCount >= 500 && (d.tabelog == null || d.tabelog < 3.1)) {
    factors.push({l:"ã€å‚è€ƒã€‘å£ã‚³ãƒŸæ•°ã®ç•°å¸¸",det:"Gãƒãƒƒãƒ—"+d.gmapCount+"ä»¶ Ã— é£Ÿã¹ãƒ­ã‚°"+(d.tabelog!=null?d.tabelog:"æœªæ²è¼‰"),w:0});
  }
  var riskPct = Math.min(Math.round((score/10)*100),100);
  var pct = 100 - riskPct;
  var level = pct<=30?"ä½æº€è¶³":pct<=55?"ã‚„ã‚„ä¸æº€":pct<=75?"æ™®é€š":"é«˜æº€è¶³";
  var color = pct<=30?"#DC2626":pct<=55?"#EA580C":pct<=75?"#CA8A04":"#16A34A";
  return {score:score,pct:pct,riskPct:riskPct,level:level,color:color,factors:factors};
}

/* â”€â”€ Helpers â”€â”€ */
function esc(s) { if (!s) return ""; var d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

function meterSVG(pct,color,level,size) {
  var r=(size-16)/2, circ=2*Math.PI*r;
  return '<div class="meter" style="width:'+size+'px;height:'+size+'px">'+
    '<svg viewBox="0 0 '+size+' '+size+'" width="'+size+'" height="'+size+'">'+
    '<circle cx="'+size/2+'" cy="'+size/2+'" r="'+r+'" fill="none" stroke="#CBD5E1" stroke-width="8"/>'+
    '<circle cx="'+size/2+'" cy="'+size/2+'" r="'+r+'" fill="none" stroke="'+color+'" stroke-width="8" '+
    'stroke-dasharray="'+(pct/100*circ)+' '+circ+'" stroke-linecap="round" '+
    'transform="rotate(-90 '+size/2+' '+size/2+')"/>'+
    '</svg>'+
    '<div class="meter-inner">'+
    '<span style="font-size:'+(size*0.23)+'px;font-weight:800;color:'+color+';font-family:\'DM Mono\',monospace">'+pct+'</span>'+
    '<span style="font-size:'+(size*0.085)+'px;color:#94A3B8;letter-spacing:1px">'+level+'</span>'+
    '</div></div>';
}

function saveResults() {
  try { localStorage.setItem("catch-risk-results", JSON.stringify(results)); } catch(e) {}
}

function sendToSheet(result, risk) {
  try {
    fetch(SHEET_URL, {method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        timestamp:result.timestamp, shopName:result.shopName, area:result.area,
        address:result.address, floor:result.floor, tabelog:result.tabelog,
        tabelogCount:result.tabelogCount, gmap:result.gmap, gmapCount:result.gmapCount,
        cheapCourse:result.cheapCourse, crownName:result.crownName,
        catchKeywords:result.catchKeywords, riskPct:risk.pct, riskLevel:risk.level,
        riskFactors:risk.factors.map(function(f){return f.l+"(-"+f.w+")"}).join(", "),
        summary:result.summary
      })
    });
  } catch(e) { console.error("Sheet error:",e); }
}

function stripTags(s) { if (!s) return s; return s.replace(/<[^>]*>/g, ""); }

/* â”€â”€ Admin â”€â”€ */
function renderAdminArea() {
  var el = document.getElementById("adminArea");
  if (!isAdmin) {
    el.innerHTML = '<button class="btn-admin" id="adminBtn">ğŸ”’ ç®¡ç†è€…</button>';
    document.getElementById("adminBtn").addEventListener("click", showPwModal);
  } else {
    el.innerHTML = '<span style="font-size:12px;color:#16A34A;display:inline-flex;align-items:center;gap:4px">ğŸ”“ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰'+
      '<button id="logoutBtn" style="background:transparent;border:none;color:#475569;font-size:11px;cursor:pointer;text-decoration:underline;margin-left:4px">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></span>';
    document.getElementById("logoutBtn").addEventListener("click", function() {
      isAdmin = false; renderAdminArea(); render();
    });
  }
}

function showPwModal() {
  var ov = document.getElementById("pwOverlay");
  ov.className = "overlay";
  ov.innerHTML = '<div class="modal">'+
    '<h3>ğŸ”’ ç®¡ç†è€…èªè¨¼</h3>'+
    '<p style="margin:0 0 20px;font-size:12px;color:#64748B">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>'+
    '<input type="password" id="pwInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%;background:#F1F5F9;border:1px solid #CBD5E1;border-radius:10px;padding:10px 14px;color:#1E293B;font-size:14px;outline:none;font-family:\'Noto Sans JP\',sans-serif;box-sizing:border-box">'+
    '<p id="pwError" style="color:#DC2626;font-size:12px;margin:8px 0 0;display:none">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>'+
    '<div class="modal-btns" style="margin-top:20px">'+
    '<button id="pwCancel" style="background:#E2E8F0;color:#475569">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'+
    '<button id="pwSubmit" style="background:#DC2626;color:#fff;font-weight:700">èªè¨¼</button>'+
    '</div></div>';
  var inp = document.getElementById("pwInput");
  setTimeout(function(){ inp.focus(); }, 100);
  inp.addEventListener("keydown", function(e) { if (e.key === "Enter") handlePwSubmit(); });
  document.getElementById("pwCancel").addEventListener("click", closePwModal);
  document.getElementById("pwSubmit").addEventListener("click", handlePwSubmit);
  ov.addEventListener("click", function(e) { if (e.target === ov) closePwModal(); });
}

function handlePwSubmit() {
  var pw = document.getElementById("pwInput").value;
  if (pw === ADMIN_PW) {
    isAdmin = true; closePwModal(); renderAdminArea(); render();
  } else {
    document.getElementById("pwError").style.display = "block";
    document.getElementById("pwInput").style.borderColor = "#DC2626";
  }
}

function closePwModal() {
  document.getElementById("pwOverlay").className = "overlay hidden";
}

/* â”€â”€ API Key UI â”€â”€ */
function renderApiSection() {
  var el = document.getElementById("apiSection");
  if (!apiKey.trim()) {
    el.innerHTML = '<div class="apibox">'+
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">'+
      '<span style="font-size:16px">ğŸ”‘</span>'+
      '<span style="font-size:13px;color:#CA8A04;font-weight:700">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span></div>'+
      '<input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">'+
      '<p style="margin:8px 0 0;font-size:11px;color:#475569">ã‚­ãƒ¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼ˆAnthropic APIã¸ã®é€šä¿¡ã®ã¿ã«ä½¿ç”¨ï¼‰</p></div>';
    document.getElementById("apiKeyInput").addEventListener("change", function() {
      apiKey = this.value;
      try { localStorage.setItem("catch-risk-apikey", apiKey); } catch(e) {}
      renderApiSection();
    });
  } else {
    el.innerHTML = '<div class="api-ok"><span>ğŸ”‘ APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿</span>'+
      '<button id="clearApiBtn">ã‚­ãƒ¼ã‚’å¤‰æ›´</button></div>';
    document.getElementById("clearApiBtn").addEventListener("click", function() {
      apiKey = "";
      try { localStorage.removeItem("catch-risk-apikey"); } catch(e) {}
      renderApiSection();
    });
  }
}

/* â”€â”€ Merge â”€â”€ */
function mergeResult(newR, list) {
  var idx = -1;
  for (var i=0; i<list.length; i++) {
    if (list[i].shopName.replace(/\s/g,"") === newR.shopName.replace(/\s/g,"")) { idx=i; break; }
  }
  if (idx === -1) return [newR].concat(list);
  var old = list[idx];
  var merged = {};
  for (var k in newR) merged[k] = newR[k];
  var allKW = (old.catchKeywords||[]).concat(newR.catchKeywords||[]);
  merged.catchKeywords = allKW.filter(function(v,i,a){return a.indexOf(v)===i}).slice(0,10);
  var rest = [];
  for (var i=0; i<list.length; i++) { if (i!==idx) rest.push(list[i]); }
  return [merged].concat(rest);
}

function registerResult(result) {
  results = mergeResult(result, results);
  expandedIdx = 0;
  saveResults();
  sendToSheet(result, calcFromData(result));
  document.getElementById("queryInput").value = "";
  render();
}

function removeResult(idx) {
  results.splice(idx, 1);
  if (expandedIdx === idx) expandedIdx = null;
  saveResults();
  render();
}

/* â”€â”€ Confirm Dialog â”€â”€ */
function showConfirmDialog(result) {
  pendingResult = result;
  var ov = document.getElementById("confirmOverlay");
  ov.className = "overlay";
  ov.innerHTML = '<div class="modal">'+
    '<h3>ğŸ” åº—èˆ—ã®ç¢ºèª</h3>'+
    '<p style="margin:0 0 16px;font-size:12px;color:#64748B">æ¤œç´¢èªã€Œ'+esc(result.query)+'ã€ã«å¯¾ã—ã¦ä»¥ä¸‹ã®åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã®åº—èˆ—ã§åˆã£ã¦ã„ã¾ã™ã‹ï¼Ÿ</p>'+
    '<div class="modal-detail">'+
    '<p style="margin:0 0 6px;font-size:15px;color:#1E293B;font-weight:700">'+esc(result.shopName)+'</p>'+
    '<p style="margin:0 0 4px;font-size:12px;color:#475569">ğŸ“ '+esc(result.address)+'</p>'+
    (result.floor!=null?'<p style="margin:0 0 4px;font-size:12px;color:#475569">ğŸ¢ '+result.floor+'F</p>':'')+
    (result.gmap!=null?'<p style="margin:0 0 4px;font-size:12px;color:#475569">â­ Gãƒãƒƒãƒ— â˜…'+result.gmap+(result.gmapCount?' ('+result.gmapCount+'ä»¶)':'')+'</p>':'')+
    (result.tabelog!=null?'<p style="margin:0;font-size:12px;color:#475569">ğŸ“Š é£Ÿã¹ãƒ­ã‚° '+result.tabelog+'</p>':'')+
    '</div>'+
    '<div class="modal-btns">'+
    '<button id="confirmNo" style="background:#E2E8F0;color:#475569">é•ã†åº—èˆ—ã§ã™</button>'+
    '<button id="confirmYes" style="background:#2563EB;color:#fff;font-weight:700">åˆã£ã¦ã„ã¾ã™</button>'+
    '</div></div>';
  document.getElementById("confirmNo").addEventListener("click", closeConfirm);
  document.getElementById("confirmYes").addEventListener("click", function() {
    if (pendingResult) registerResult(pendingResult);
    closeConfirm();
  });
  ov.addEventListener("click", function(e) { if (e.target === ov) closeConfirm(); });
}
function closeConfirm() {
  pendingResult = null;
  document.getElementById("confirmOverlay").className = "overlay hidden";
}

/* â”€â”€ Search â”€â”€ */
function showLoading(on) {
  var el = document.getElementById("loadingArea");
  var btn = document.getElementById("searchBtn");
  if (on) {
    el.className = "";
    el.innerHTML = '<div class="loading"><div class="spinner"></div>'+
      '<p style="color:#64748B;font-size:13px;margin:0">ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’å®Ÿè¡Œä¸­â€¦ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ»Googleãƒãƒƒãƒ—ãƒ»å£ã‚³ãƒŸã‚’èª¿æŸ»ã—ã¦ã„ã¾ã™</p>'+
      '<p style="color:#94A3B8;font-size:11px;margin:8px 0 0">é£Ÿã¹ãƒ­ã‚°ãƒ»Googleãƒãƒƒãƒ—ãƒ»ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã‚’æ¨ªæ–­æ¤œç´¢ã—ã¦ã„ã¾ã™ï¼ˆ10ã€œ20ç§’ï¼‰</p></div>';
    btn.disabled = true; btn.textContent = "æ¤œç´¢ä¸­â€¦";
  } else {
    el.className = "hidden"; el.innerHTML = "";
    btn.disabled = false; btn.textContent = "èª¿æŸ»é–‹å§‹";
  }
}
function showError(msg) {
  var el = document.getElementById("errorArea");
  el.className = ""; el.innerHTML = '<div class="error-box">'+esc(msg)+'</div>';
}
function hideError() {
  var el = document.getElementById("errorArea");
  el.className = "hidden"; el.innerHTML = "";
}

async function doSearch() {
  var q = document.getElementById("queryInput").value.trim();
  var a = document.getElementById("areaInput").value.trim();
  if (!q) return;
  if (!apiKey.trim()) { showError("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç”»é¢ä¸Šéƒ¨ã®ğŸ”‘æ¬„ï¼‰"); return; }
  showLoading(true);
  hideError();
  try {
    var resp = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {"Content-Type":"application/json","x-api-key":apiKey.trim(),"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body: JSON.stringify({
        model:"claude-sonnet-4-20250514", max_tokens:2000, system:SYSTEM_PROMPT,
        messages:[{role:"user",content:"ä»¥ä¸‹ã®åº—èˆ—ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„: "+q+(a?"ï¼ˆã‚¨ãƒªã‚¢: "+a+"ï¼‰":"")}],
        tools:[{type:"web_search_20250305",name:"web_search"}]
      })
    });
    var data;
    try {
      var rawText = await resp.text();
      data = JSON.parse(rawText);
    } catch(parseErr) {
      showError("APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      showLoading(false); return;
    }
    if (data.error) {
      showError("APIã‚¨ãƒ©ãƒ¼: "+(data.error.message||JSON.stringify(data.error)));
      showLoading(false); return;
    }
    var texts = [];
    if (data.content) {
      for (var i=0; i<data.content.length; i++) {
        if (data.content[i].type==="text") texts.push(data.content[i].text);
      }
    }
    var allText = texts.join("\n").replace(/```json|```/g,"").trim();
    var m = allText.match(/\{[\s\S]*\}/);
    if (!m) { showError("æ¤œç´¢çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åº—åã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); showLoading(false); return; }
    var parsed = JSON.parse(m[0]);
    var now = new Date();
    var pad = function(n){return ("0"+n).slice(-2)};
    var ts = now.getFullYear()+"/"+pad(now.getMonth()+1)+"/"+pad(now.getDate())+" "+pad(now.getHours())+":"+pad(now.getMinutes());
    var result = {
      id: Date.now()+"-"+Math.random().toString(36).slice(2,8),
      query:q, area:a, shopName:stripTags(parsed.shopName)||q,
      address:stripTags(parsed.address)||"ä¸æ˜", floor:parsed.floor,
      tabelog:parsed.tabelog, tabelogCount:parsed.tabelogCount,
      gmap:parsed.gmap, gmapCount:parsed.gmapCount,
      cheapCourse:parsed.cheapCourse, crownName:parsed.crownName||false,
      catchKeywords:(parsed.catchKeywords||[]).map(stripTags),
      summary:stripTags(parsed.summary)||"", timestamp:ts
    };
    var sn = (parsed.shopName||"").toLowerCase();
    var ql = q.toLowerCase();
    var isExact = sn.indexOf(ql)>=0 || ql.indexOf(sn)>=0 || q.length>=10;
    if (isExact) { registerResult(result); } else { showConfirmDialog(result); }
  } catch(e) {
    showError("æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: "+e.message);
  }
  showLoading(false);
}

/* â”€â”€ Render â”€â”€ */
function render() {
  var area = document.getElementById("resultsArea");
  var empty = document.getElementById("emptyState");
  var toggle = document.getElementById("viewToggleArea");
  var isMobile = window.innerWidth < 480;
  var mSize = isMobile ? 80 : 120;

  if (results.length === 0) {
    area.innerHTML = "";
    toggle.className = "hidden";
    empty.innerHTML = '<div class="empty"><div style="font-size:48px;margin-bottom:16px">ğŸ®</div>'+
      '<p style="font-size:14px;line-height:1.7">ä¸Šã®æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«å±…é…’å±‹ã®åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>'+
      'é£Ÿã¹ãƒ­ã‚°ãƒ»Googleãƒãƒƒãƒ—ãƒ»ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã‚’è‡ªå‹•æ¤œç´¢ã—ã€<br>ã‚­ãƒ£ãƒƒãƒå±…é…’å±‹ã®å¯èƒ½æ€§ã‚’åˆ¤å®šã—ã¾ã™ã€‚</p>'+
      '<p style="font-size:13px;color:#475569;margin-top:16px;line-height:1.7">èª¿æŸ»çµæœã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•é›†ç´„ã•ã‚Œã¾ã™ã€‚</p>'+
      '<div style="margin-top:20px;font-size:12px;color:#475569;line-height:1.8">'+
      '<p>ğŸ’¡ ã€Œåº—åï¼‹ã‚¨ãƒªã‚¢åã€ã§å…¥åŠ›ã™ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™</p>'+
      '<p style="color:#334155">åº—åã‚’å…¥åŠ›ã—ã¦èª¿æŸ»ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼ˆã‚¨ãƒªã‚¢ã¯å¤‰æ›´å¯èƒ½ã§ã™ï¼‰</p></div></div>';
    return;
  }
  empty.innerHTML = "";

  var lowCount=0, medCount=0;
  for (var i=0; i<results.length; i++) {
    var p = calcFromData(results[i]).pct;
    if (p<=30) lowCount++;
    else if (p>30 && p<=55) medCount++;
  }

  toggle.className = "view-toggle";
  var toggleHtml = '<div class="view-left">'+
    '<button class="tab-btn '+(currentView==="cards"?"active":"inactive")+'" data-view="cards">ã‚«ãƒ¼ãƒ‰è¡¨ç¤º</button>'+
    '<button class="tab-btn '+(currentView==="table"?"active":"inactive")+'" data-view="table">ä¸€è¦§è¡¨ç¤º</button>'+
    '<span class="stats" style="margin-left:8px">'+results.length+'åº—èˆ—èª¿æŸ»æ¸ˆ';
  if (lowCount>0) toggleHtml+='<span style="color:#DC2626;margin-left:6px">ï¼ˆä½æº€è¶³'+lowCount+'ï¼‰</span>';
  if (medCount>0) toggleHtml+='<span style="color:#EA580C;margin-left:4px">ï¼ˆã‚„ã‚„ä¸æº€'+medCount+'ï¼‰</span>';
  toggleHtml += '</span></div>';
  if (isAdmin) {
    toggleHtml += '<button class="btn-export" id="exportBtn"><span style="font-size:16px">ğŸ“¥</span> CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆ'+results.length+'ä»¶ï¼‰</button>';
  }
  toggle.innerHTML = toggleHtml;

  var tabBtns = toggle.querySelectorAll(".tab-btn");
  for (var ti=0; ti<tabBtns.length; ti++) {
    tabBtns[ti].addEventListener("click", function() {
      currentView = this.getAttribute("data-view");
      render();
    });
  }
  if (isAdmin && document.getElementById("exportBtn")) {
    document.getElementById("exportBtn").addEventListener("click", exportToCSV);
  }

  if (currentView === "cards") { renderCards(area, mSize); }
  else { renderTable(area); }
}

function renderCards(area, mSize) {
  var html = "";
  for (var idx=0; idx<results.length; idx++) {
    var r = results[idx];
    var risk = calcFromData(r);
    var bg = risk.pct<=30?"linear-gradient(135deg,#FEE2E2 0%,#FFFFFF 100%)":risk.pct<=55?"linear-gradient(135deg,#FFF7ED 0%,#FFFFFF 100%)":"linear-gradient(135deg,#FFFFFF 0%,#FFFFFF 100%)";
    var bd = risk.pct<=30?"#FCA5A5":risk.pct<=55?"#FDBA74":"#CBD5E1";
    var sh = risk.pct<=30?"0 0 30px rgba(220,38,38,0.15)":"none";
    html += '<div class="card" style="background:'+bg+';border:1px solid '+bd+';box-shadow:'+sh+'" data-idx="'+idx+'">';
    html += '<div class="card-header">';
    html += meterSVG(risk.pct, risk.color, risk.level, mSize);
    html += '<div style="flex:1;min-width:0">';
    html += '<div style="display:flex;align-items:flex-start;justify-content:space-between">';
    html += '<h3>'+esc(r.shopName)+'</h3>';
    if (isAdmin) html += '<button class="btn-remove" data-rm="'+idx+'" title="å‰Šé™¤ï¼ˆç®¡ç†è€…ï¼‰">âœ•</button>';
    html += '</div>';
    html += '<p class="addr">'+esc(r.address)+(r.area?'<span class="area-badge">'+esc(r.area)+'</span>':'')+'</p>';
    html += '<div class="tags">';
    if (r.tabelog!=null) html+='<span class="tag" style="background:'+(r.tabelog<3.1?"#7F1D1D":"#1E293B")+';color:'+(r.tabelog<3.1?"#FCA5A5":"#94A3B8")+'">é£Ÿã¹ãƒ­ã‚° '+r.tabelog+(r.tabelogCount?'ï¼ˆ'+r.tabelogCount+'ä»¶ï¼‰':'')+'</span>';
    if (r.gmap!=null) {
      var gmapBg = (r.gmapCount>=500 && r.gmap>=4.0)?"#7C2D12":"#1E293B";
      var gmapCol = (r.gmapCount>=500 && r.gmap>=4.0)?"#FDBA74":"#94A3B8";
      html+='<span class="tag" style="background:'+gmapBg+';color:'+gmapCol+'">Gãƒãƒƒãƒ— â˜…'+r.gmap+(r.gmapCount?'ï¼ˆ'+r.gmapCount+'ä»¶ï¼‰':'')+'</span>';
    }
    if (r.cheapCourse!=null && r.cheapCourse<3300) html+='<span class="tag" style="background:#7C2D12;color:#FDBA74">é£²æ”¾'+r.cheapCourse+'å††</span>';
    html += '</div>';
    html += '<p class="ts">'+esc(r.timestamp)+'</p>';
    html += '</div></div>';

    if (expandedIdx === idx) {
      html += '<div class="detail">';
      if (r.summary) html += '<p class="summary-box">'+esc(r.summary)+'</p>';
      html += '<h4 style="color:#1E293B;font-size:14px;margin:0 0 12px">æ¸›ç‚¹è¦å› åˆ†æ</h4>';
      if (risk.factors.length===0) html+='<p style="color:#94A3B8;font-size:13px">ç‰¹ç­†ã™ã¹ãæ¸›ç‚¹è¦å› ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
      for (var fi=0; fi<risk.factors.length; fi++) {
        var f = risk.factors[fi];
        var fbg = f.w>=3?"#DC2626":f.w>=2?"#EA580C":f.w>=1?"#CA8A04":"#475569";
        html += '<div class="factor"><span class="fw" style="background:'+fbg+'">-'+f.w+'</span><div><span style="color:#334155;font-size:13px;font-weight:600">'+esc(f.l)+'</span><span style="color:#64748B;font-size:12px;margin-left:8px">'+esc(f.det)+'</span></div></div>';
      }
      if (r.catchKeywords && r.catchKeywords.length>0) {
        html += '<div style="margin-top:16px"><h4 style="color:#DC2626;font-size:13px;margin:0 0 8px">å£ã‚³ãƒŸã‹ã‚‰æ¤œå‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h4>';
        for (var ki=0; ki<r.catchKeywords.length; ki++) {
          html += '<div class="kw-item">ã€Œ'+esc(r.catchKeywords[ki])+'ã€</div>';
        }
        html += '</div>';
      }
      html += '</div>';
    }
    html += '</div>';
  }
  area.innerHTML = html;

  var cards = area.querySelectorAll(".card");
  for (var ci=0; ci<cards.length; ci++) {
    cards[ci].addEventListener("click", function(e) {
      if (e.target.closest && e.target.closest(".btn-remove")) return;
      var i = parseInt(this.getAttribute("data-idx"));
      expandedIdx = (expandedIdx===i) ? null : i;
      render();
    });
  }
  var rmBtns = area.querySelectorAll(".btn-remove");
  for (var ri=0; ri<rmBtns.length; ri++) {
    rmBtns[ri].addEventListener("click", function(e) {
      e.stopPropagation();
      removeResult(parseInt(this.getAttribute("data-rm")));
    });
  }
}

function renderTable(area) {
  var headers = ["No.","åº—å","ã‚¨ãƒªã‚¢","ä½æ‰€","éš","é£Ÿã¹ãƒ­ã‚°","Gãƒãƒƒãƒ—","Gå£ã‚³ãƒŸæ•°","æœ€å®‰ã‚³ãƒ¼ã‚¹","ã‚¹ã‚³ã‚¢","åˆ¤å®š","ã‚­ãƒ£ãƒƒãƒé–¢é€£","èª¿æŸ»æ—¥æ™‚"];
  var html = '<div style="overflow-x:auto;border-radius:14px;border:1px solid #CBD5E1"><table class="data-table"><thead><tr>';
  for (var hi=0; hi<headers.length; hi++) html += '<th>'+headers[hi]+'</th>';
  html += '</tr></thead><tbody>';
  for (var i=0; i<results.length; i++) {
    var r = results[i];
    var risk = calcFromData(r);
    html += '<tr>';
    html += '<td style="color:#64748B">'+(i+1)+'</td>';
    html += '<td style="color:#1E293B;font-weight:600;max-width:180px">'+esc(r.shopName)+'</td>';
    html += '<td style="color:#64748B;font-size:11px">'+(r.area||"-")+'</td>';
    html += '<td style="color:#94A3B8;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(r.address)+'</td>';
    html += '<td style="color:'+(r.floor>=4?"#DC2626":"#94A3B8")+'">'+(r.floor!=null?r.floor+"F":"-")+'</td>';
    html += '<td style="color:'+(r.tabelog!=null&&r.tabelog<3.1?"#DC2626":"#94A3B8")+'">'+(r.tabelog!=null?r.tabelog:"-")+'</td>';
    html += '<td style="color:#94A3B8">'+(r.gmap!=null?"â˜…"+r.gmap:"-")+'</td>';
    html += '<td style="color:'+(r.gmapCount>=500?"#EA580C":"#94A3B8")+'">'+(r.gmapCount!=null?r.gmapCount:"-")+'</td>';
    html += '<td style="color:'+(r.cheapCourse!=null&&r.cheapCourse<2000?"#DC2626":"#94A3B8")+'">'+(r.cheapCourse!=null?r.cheapCourse+"å††":"-")+'</td>';
    html += '<td><span style="background:'+risk.color+';color:#fff;padding:2px 10px;border-radius:10px;font-weight:700;font-size:12px;font-family:\'DM Mono\',monospace">'+risk.pct+'</span></td>';
    html += '<td style="color:'+risk.color+';font-weight:700;font-size:12px">'+risk.level+'</td>';
    var kwCol = (r.catchKeywords&&r.catchKeywords.length>0)?"#DC2626":"#94A3B8";
    var kwTxt = (r.catchKeywords&&r.catchKeywords.length>0)?r.catchKeywords.length+"ä»¶æ¤œå‡º":"ãªã—";
    html += '<td style="color:'+kwCol+'">'+kwTxt+'</td>';
    html += '<td style="color:#475569;white-space:nowrap;font-size:11px">'+esc(r.timestamp)+'</td>';
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  area.innerHTML = html;
}

/* â”€â”€ CSV Export â”€â”€ */
function exportToCSV() {
  var rows = [["No.","åº—å","ã‚¨ãƒªã‚¢","ä½æ‰€","éšæ•°","é£Ÿã¹ãƒ­ã‚°è©•ç‚¹","é£Ÿã¹ãƒ­ã‚°å£ã‚³ãƒŸæ•°","Gãƒãƒƒãƒ—è©•ç‚¹","Gãƒãƒƒãƒ—å£ã‚³ãƒŸæ•°","æœ€å®‰é£²æ”¾ã‚³ãƒ¼ã‚¹","å† èª","ã‚­ãƒ£ãƒƒãƒé–¢é€£å£ã‚³ãƒŸ","æº€è¶³åº¦ã‚¹ã‚³ã‚¢","åˆ¤å®š","æ¸›ç‚¹è¦å› ","ç‰¹è¨˜äº‹é …","èª¿æŸ»æ—¥æ™‚"]];
  for (var i=0; i<results.length; i++) {
    var r = results[i];
    var risk = calcFromData(r);
    rows.push([
      i+1, r.shopName, r.area||"", r.address,
      r.floor!=null?r.floor+"F":"",
      r.tabelog!=null?r.tabelog:"", r.tabelogCount!=null?r.tabelogCount:"",
      r.gmap!=null?r.gmap:"", r.gmapCount!=null?r.gmapCount:"",
      r.cheapCourse!=null?r.cheapCourse:"", r.crownName?"â—‹":"",
      (r.catchKeywords||[]).join(" / "),
      risk.pct, risk.level,
      risk.factors.map(function(f){return f.l+"(-"+f.w+")"}).join(", "),
      r.summary, r.timestamp||""
    ]);
  }
  var csv = rows.map(function(row){
    return row.map(function(cell){
      var s = String(cell==null?"":cell);
      if (s.indexOf(",")>=0||s.indexOf('"')>=0||s.indexOf("\n")>=0) return '"'+s.replace(/"/g,'""')+'"';
      return s;
    }).join(",");
  }).join("\r\n");
  var blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "ã‚­ãƒ£ãƒƒãƒèª¿æŸ»_"+new Date().toISOString().slice(0,10)+".csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* â”€â”€ Init â”€â”€ */
document.getElementById("searchBtn").addEventListener("click", doSearch);
document.getElementById("queryInput").addEventListener("keydown", function(e){if(e.key==="Enter")doSearch()});
document.getElementById("areaInput").addEventListener("keydown", function(e){if(e.key==="Enter")doSearch()});
renderApiSection();
renderAdminArea();
render();
</script>
</body>
</html>
