<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é‡‘æ²¢ç‰‡ç”º ã‚­ãƒ£ãƒƒãƒå±…é…’å±‹æŒ‡æ•°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:linear-gradient(180deg,#020617 0%,#0F172A 40%,#020617 100%);color:#F1F5F9;font-family:'Noto Sans JP',sans-serif;min-height:100vh}
@keyframes spin{to{transform:rotate(360deg)}}
.wrap{max-width:960px;margin:0 auto;padding:24px 20px 60px}
.header{padding:36px 20px 28px;background:linear-gradient(180deg,rgba(220,38,38,0.08) 0%,transparent 100%);border-bottom:1px solid #1E293B}
.header-inner{max-width:960px;margin:0 auto}
h1{font-size:24px;font-weight:800;line-height:1.3;background:linear-gradient(135deg,#F1F5F9 0%,#94A3B8 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.subtitle{margin:4px 0 0;font-size:13px;color:#64748B}
.definition{margin:10px 0 0;font-size:11px;color:#475569;line-height:1.8}
.badge{background:#DC2626;color:#fff;padding:3px 12px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:1.5px}
.apibox{background:#0F172A;border:1px solid #CA8A04;border-radius:14px;padding:16px 20px;margin-bottom:16px}
.apibox input{width:100%;background:#020617;border:1px solid #1E293B;border-radius:10px;padding:10px 14px;color:#F1F5F9;font-size:13px;outline:none;font-family:monospace;margin-top:8px;box-sizing:border-box}
.api-ok{font-size:12px;color:#065F46;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.api-ok button{background:none;border:none;color:#475569;font-size:11px;cursor:pointer;text-decoration:underline}
.searchbox{display:flex;gap:10px;margin-bottom:12px;background:#0F172A;border:1px solid #1E293B;border-radius:14px;padding:8px;align-items:center;flex-wrap:wrap}
.searchbox input{background:transparent;border:none;outline:none;color:#F1F5F9;font-size:15px;padding:10px 14px;font-family:'Noto Sans JP',sans-serif;min-width:0}
.q-input{flex:2 1 180px}
.a-input{flex:1 1 120px;color:#94A3B8 !important;font-size:14px !important}
.divider{width:1px;height:24px;background:#1E293B;flex-shrink:0}
.btn-search{background:#DC2626;color:#fff;border:none;border-radius:10px;padding:10px 24px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans JP',sans-serif;white-space:nowrap}
.btn-search:disabled{background:#1E293B;cursor:wait;opacity:0.7}
.privacy{display:flex;align-items:flex-start;gap:8px;margin-bottom:20px;background:#0F172A;border:1px solid #1E293B;border-radius:10px;padding:10px 14px}
.privacy p{font-size:11px;color:#64748B;line-height:1.7}
.loading{background:#0F172A;border:1px solid #1E293B;border-radius:14px;padding:20px 24px;margin-bottom:20px;text-align:center}
.spinner{width:40px;height:40px;border:3px solid #1E293B;border-top-color:#DC2626;border-radius:50%;margin:0 auto 14px;animation:spin 1s linear infinite}
.error-box{background:#1a0505;border:1px solid #7F1D1D;border-radius:14px;padding:16px 20px;margin-bottom:20px;color:#FCA5A5;font-size:13px}
.card{border-radius:16px;padding:20px 24px;margin-bottom:12px;transition:all 0.3s;cursor:pointer}
.card-header{display:flex;align-items:center;gap:20px}
.card h3{font-size:17px;font-weight:700;color:#F1F5F9;line-height:1.4;margin:0}
.card .addr{margin:4px 0 0;font-size:12px;color:#64748B;word-break:break-all}
.tags{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.tag{padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600;display:inline-block}
.ts{margin:4px 0 0;font-size:10px;color:#334155}
.detail{margin-top:20px;padding-top:16px;border-top:1px solid #1E293B}
.summary-box{background:#1E293B;padding:12px 16px;border-radius:10px;font-size:13px;color:#CBD5E1;line-height:1.7;margin:0 0 16px}
.factor{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px}
.fw{padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;white-space:nowrap;min-width:28px;text-align:center;color:#fff}
.kw-item{background:#1E293B;border-left:3px solid #DC2626;padding:8px 12px;margin-bottom:6px;border-radius:0 8px 8px 0;color:#CBD5E1;font-size:12px;font-style:italic;line-height:1.5}
.same-addr-box{margin-top:12px;background:#1E293B;padding:10px 14px;border-radius:10px;font-size:12px;color:#FDBA74}
.meter{position:relative;flex-shrink:0}
.meter-inner{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.legend{margin-top:32px;background:#0F172A;border:1px solid #1E293B;border-radius:16px;padding:20px 24px}
.legend h4{margin:0 0 14px;font-size:14px;color:#F1F5F9;font-weight:700}
.legend-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 16px;font-size:11px;color:#94A3B8;line-height:1.8}
.legend-levels{margin-top:14px;display:flex;gap:14px;font-size:11px;flex-wrap:wrap}
.footer{margin-top:24px;text-align:center;font-size:11px;color:#334155;line-height:1.8}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9998;padding:20px}
.modal{background:#0F172A;border:1px solid #1E293B;border-radius:16px;padding:32px 28px;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.modal h3{margin:0 0 6px;font-size:16px;color:#F1F5F9;font-weight:700}
.modal-detail{background:#020617;border:1px solid #1E293B;border-radius:12px;padding:16px;margin-bottom:20px}
.modal-btns{display:flex;gap:10px}
.modal-btns button{flex:1;border:none;border-radius:10px;padding:12px;font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif}
.area-badge{margin-left:8px;background:#1E293B;color:#94A3B8;padding:2px 8px;border-radius:10px;font-size:11px;display:inline-block}
.stats{font-size:12px;color:#475569;margin-bottom:16px}
.empty{text-align:center;padding:48px 20px;color:#334155}
.hidden{display:none}
@media(max-width:480px){
  .card h3{font-size:14px}
  .legend-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
      <span style="font-size:26px">ğŸ”</span>
      <span class="badge">LIVE SEARCH</span>
    </div>
    <h1>é‡‘æ²¢ç‰‡ç”º ã‚­ãƒ£ãƒƒãƒå±…é…’å±‹æŒ‡æ•°</h1>
    <p class="subtitle">Catch Izakaya Risk Index â€” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç‰ˆ v0.7</p>
    <p class="definition">æœ¬ãƒ„ãƒ¼ãƒ«ã®èª¿æŸ»å¯¾è±¡ã¯ã€Œé…’é¡ã®æä¾›ã‚’ä¸»ã¨ã—ã€é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹é£²é£Ÿåº—ã€ï¼ˆå±…é…’å±‹å‹é£²é£Ÿåº—ï¼‰ã§ã™ã€‚åº—åã«ã€Œå±…é…’å±‹ã€ã‚’å«ã¾ãªã„æ¥­æ…‹ï¼ˆæµ·é®®ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒ»å€‹å®¤å’Œé£Ÿç­‰ï¼‰ã‚‚ã€ä¸Šè¨˜ã®è¦ä»¶ã‚’æº€ãŸã™å ´åˆã¯å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚</p>
  </div>
</div>

<div class="wrap">
  <div id="apiSection"></div>

  <div class="searchbox">
    <input type="text" id="queryInput" class="q-input" placeholder="åº—åï¼ˆä¾‹ï¼šâ—‹â—‹å±…é…’å±‹ï¼‰">
    <div class="divider"></div>
    <input type="text" id="areaInput" class="a-input" placeholder="ã‚¨ãƒªã‚¢ï¼ˆå¤‰æ›´å¯ï¼‰" value="é‡‘æ²¢ç‰‡ç”ºã‚¨ãƒªã‚¢">
    <button class="btn-search" id="searchBtn">èª¿æŸ»é–‹å§‹</button>
  </div>

  <div class="privacy">
    <span style="font-size:14px;flex-shrink:0;margin-top:1px">ğŸ”</span>
    <p>æœ¬ãƒ„ãƒ¼ãƒ«ã¯å…¥åŠ›ã•ã‚ŒãŸåº—åãŠã‚ˆã³å…¬é–‹ã‚°ãƒ«ãƒ¡ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã—ãŸè©•ç‚¹ãƒ»å£ã‚³ãƒŸæƒ…å ±ã®ã¿ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚åˆ©ç”¨è€…ã®å€‹äººæƒ…å ±ã¯ä¸€åˆ‡åé›†ã•ã‚Œã¾ã›ã‚“ã€‚èª¿æŸ»çµæœã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•é›†ç´„ã•ã‚Œã¾ã™ã€‚</p>
  </div>

  <div id="loadingArea" class="hidden"></div>
  <div id="errorArea" class="hidden"></div>
  <div id="statsArea" class="hidden"></div>
  <div id="resultsArea"></div>
  <div id="emptyState"></div>

  <div class="legend">
    <h4>ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°åŸºæº–</h4>
    <div class="legend-grid">
      <div>â€¢ æ‰€åœ¨éš4Fä»¥ä¸Š â†’ +2 / 2-3F â†’ +1</div>
      <div>â€¢ é£²æ”¾ä»˜2,000å††æœªæº€ â†’ +2 / 3,300å††æœªæº€ â†’ +1</div>
      <div>â€¢ å£ã‚³ãƒŸã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€3ä»¶è¶… â†’ +3</div>
      <div>â€¢ å£ã‚³ãƒŸã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€1-2ä»¶ â†’ +2</div>
      <div>â€¢ åŒä½æ‰€ã«åˆ¥åº—èˆ— â†’ +1</div>
      <div>â€¢ SEOçš„å† èªï¼ˆå€‹å®¤/å®Œå…¨å€‹å®¤ç­‰ï¼‰â†’ +1</div>
      <div>â€¢ Gãƒãƒƒãƒ—â˜…3.5ä»¥ä¸‹ â†’ +1</div>
      <div style="color:#475569">â€» é£Ÿã¹ãƒ­ã‚°è©•ç‚¹ã¯å‚è€ƒè¡¨ç¤ºï¼ˆã‚¹ã‚³ã‚¢éåŠ ç®—ï¼‰</div>
    </div>
    <div class="legend-levels">
      <span><span style="color:#DC2626;font-weight:700">â–  70ã€œ100</span> å±é™º</span>
      <span><span style="color:#EA580C;font-weight:700">â–  45ã€œ69</span> è¦æ³¨æ„</span>
      <span><span style="color:#CA8A04;font-weight:700">â–  25ã€œ44</span> ã‚„ã‚„æ³¨æ„</span>
      <span><span style="color:#16A34A;font-weight:700">â–  0ã€œ24</span> ä½ãƒªã‚¹ã‚¯</span>
    </div>
  </div>

  <div class="footer">
    <p>é‡‘æ²¢å¸‚ç‰‡ç”º å®¢å¼•ãå•é¡Œèª¿æŸ» â”€ åŒ—é™¸å¤§å­¦ å±±æœ¬ç ”ç©¶å®¤</p>
    <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ç‰ˆ v0.7 â”€ èª¿æŸ»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå‚è€ƒæŒ‡æ¨™ã§ã™</p>
  </div>
</div>

<div id="confirmOverlay" class="overlay hidden"></div>

<script>
/* â”€â”€ Config â”€â”€ */
var SHEET_URL = "https://script.google.com/macros/s/AKfycbxnZEpb_L_nLHRx3Iwn4L-gWQG6c1qdseRf0-MrW8VLIdlI8ZZKSfMY0dImEnDA1wB0/exec";

var SYSTEM_PROMPT = 'ã‚ãªãŸã¯é£²é£Ÿåº—ã®å®¢å¼•ããƒ»ã¼ã£ãŸãã‚Šãƒªã‚¹ã‚¯ã‚’èª¿æŸ»ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\nã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®æƒ…å ±ã‚’åé›†ã—ã€JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚\nãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã¯ä¸è¦ã§ã™ã€‚\n\nã€å¿…é ˆæ¤œç´¢ã€‘\næ¤œç´¢1: ã€Œ(åº—å) ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ã€â†’ ä½æ‰€ãƒ»éšæ•°ãƒ»é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹æœ€å®‰ä¾¡æ ¼ãƒ»åŒãƒ“ãƒ«å†…ã®åˆ¥åº—èˆ—ã‚’ç¢ºèª\næ¤œç´¢2: ã€Œ(åº—å) ã‚­ãƒ£ãƒƒãƒ ã¼ã£ãŸãã‚Š å£ã‚³ãƒŸã€â†’ ã‚­ãƒ£ãƒƒãƒãƒ»å®¢å¼•ããƒ»ã¼ã£ãŸãã‚Šã«é–¢ã™ã‚‹å£ã‚³ãƒŸã‚’æ¤œç´¢\næ¤œç´¢3: ã€Œ(åº—å) Googleãƒãƒƒãƒ— å£ã‚³ãƒŸ è©•ä¾¡ã€â†’ Gãƒãƒƒãƒ—ã®æ˜Ÿè©•ä¾¡ãƒ»å£ã‚³ãƒŸä»¶æ•°ã‚’å–å¾—\n\næ¤œç´¢çµæœã«é£Ÿã¹ãƒ­ã‚°ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãŸå ´åˆã¯ã€è©•ç‚¹ã¨å£ã‚³ãƒŸæ•°ã‚‚è¨˜éŒ²ã—ã¦ãã ã•ã„ï¼ˆå°‚ç”¨ã®æ¤œç´¢ã¯ä¸è¦ï¼‰ã€‚\n\nå›ç­”ã¯JSONå½¢å¼ã®ã¿ã€‚\n\n{\n  "shopName": "æ­£å¼åº—å",\n  "address": "ä½æ‰€ï¼ˆãƒ“ãƒ«åãƒ»éšæ•°ã‚’å«ã‚€ï¼‰",\n  "floor": "éšæ•°ã®æ•°å€¤ï¼ˆB1Fãªã‚‰-1ã€1Fãªã‚‰nullã€ä¸æ˜ãªã‚‰nullï¼‰",\n  "tabelog": "é£Ÿã¹ãƒ­ã‚°è©•ç‚¹ï¼ˆãªã‘ã‚Œã°nullï¼‰",\n  "tabelogCount": "é£Ÿã¹ãƒ­ã‚°å£ã‚³ãƒŸä»¶æ•°ï¼ˆãªã‘ã‚Œã°nullï¼‰",\n  "gmap": "Googleãƒãƒƒãƒ—æ˜Ÿè©•ä¾¡ï¼ˆä¸æ˜ãªã‚‰nullï¼‰",\n  "gmapCount": "Googleãƒãƒƒãƒ—å£ã‚³ãƒŸä»¶æ•°ï¼ˆä¸æ˜ãªã‚‰nullï¼‰",\n  "cheapCourse": "æœ€å®‰ã®é£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹ä¾¡æ ¼ï¼ˆä¸æ˜ãªã‚‰nullï¼‰",\n  "crownName": "åº—åã«SEOå† èªãŒã‚ã‚‹ã‹ï¼ˆtrue/falseï¼‰",\n  "sameAddress": "åŒã˜ãƒ“ãƒ«ã®åˆ¥é£²é£Ÿåº—åï¼ˆãªã‘ã‚Œã°nullï¼‰",\n  "catchKeywords": "ã‚­ãƒ£ãƒƒãƒé–¢é€£ã®å£ã‚³ãƒŸï¼ˆé…åˆ—ã€æœ€å¤§5ä»¶ï¼‰",\n  "summary": "ç‰¹è¨˜äº‹é …ï¼ˆ1ã€œ2æ–‡ï¼‰"\n}';

/* â”€â”€ State â”€â”€ */
var results = [];
var expandedIdx = null;
var pendingResult = null;
var apiKey = "";
try { apiKey = localStorage.getItem("catch-risk-apikey") || ""; } catch(e) {}
try { var saved = localStorage.getItem("catch-risk-results"); if (saved) results = JSON.parse(saved); } catch(e) {}

/* â”€â”€ Score Calculation â”€â”€ */
function calcFromData(d) {
  var factors = [], score = 0;
  if (d.floor != null && d.floor >= 4) { factors.push({l:"ç©ºä¸­éšï¼ˆé«˜å±¤ï¼‰",det:d.floor+"F",w:2}); score+=2; }
  else if (d.floor != null && d.floor >= 2) { factors.push({l:"ç©ºä¸­éš",det:d.floor+"F",w:1}); score+=1; }
  if (d.cheapCourse != null && d.cheapCourse < 2000) { factors.push({l:"éç¾å®Ÿçš„ä½ä¾¡æ ¼",det:"é£²æ”¾ä»˜"+d.cheapCourse+"å††",w:2}); score+=2; }
  else if (d.cheapCourse != null && d.cheapCourse < 3300) { factors.push({l:"ä½ä¾¡æ ¼ã‚³ãƒ¼ã‚¹",det:d.cheapCourse+"å††",w:1}); score+=1; }
  if (d.catchKeywords && d.catchKeywords.length >= 3) { factors.push({l:"ã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€å¤šæ•°",det:d.catchKeywords.length+"ä»¶æ¤œå‡º",w:3}); score+=3; }
  else if (d.catchKeywords && d.catchKeywords.length > 0) { factors.push({l:"ã€Œã‚­ãƒ£ãƒƒãƒ/ã¼ã£ãŸãã‚Šã€æ¤œå‡º",det:d.catchKeywords.length+"ä»¶",w:2}); score+=2; }
  if (d.sameAddress) { factors.push({l:"åŒä½æ‰€ã«åˆ¥åº—èˆ—",det:d.sameAddress,w:1}); score+=1; }
  if (d.crownName) { factors.push({l:"SEOçš„å† èªãƒ‘ã‚¿ãƒ¼ãƒ³",det:"ã€Œå€‹å®¤ã€ã€Œå®Œå…¨å€‹å®¤ã€ç­‰ã‚’åº—åã«ä½¿ç”¨",w:1}); score+=1; }
  if (d.gmap != null && d.gmap <= 3.5) { factors.push({l:"Gãƒãƒƒãƒ—ä½è©•ä¾¡",det:"â˜…"+d.gmap,w:1}); score+=1; }
  if (d.tabelog != null && d.gmap != null && (d.gmap-d.tabelog)>=0.7) {
    factors.push({l:"ã€å‚è€ƒã€‘è©•ç‚¹ä¹–é›¢",det:"Gãƒãƒƒãƒ—â˜…"+d.gmap+" vs é£Ÿã¹ãƒ­ã‚°"+d.tabelog+"ï¼ˆå·®"+(d.gmap-d.tabelog).toFixed(1)+"ï¼‰",w:0});
  }
  if (d.tabelog != null && d.tabelog <= 3.02) { factors.push({l:"ã€å‚è€ƒã€‘é£Ÿã¹ãƒ­ã‚°ä½è©•ä¾¡",det:""+d.tabelog,w:0}); }
  if (d.gmapCount >= 500 && (d.tabelog == null || d.tabelog < 3.1)) {
    factors.push({l:"ã€å‚è€ƒã€‘å£ã‚³ãƒŸæ•°ã®ç•°å¸¸",det:"Gãƒãƒƒãƒ—"+d.gmapCount+"ä»¶ Ã— é£Ÿã¹ãƒ­ã‚°"+(d.tabelog!=null?d.tabelog:"æœªæ²è¼‰"),w:0});
  }
  var pct = Math.min(Math.round((score/10)*100),100);
  var level = pct>=70?"å±é™º":pct>=45?"è¦æ³¨æ„":pct>=25?"ã‚„ã‚„æ³¨æ„":"ä½ãƒªã‚¹ã‚¯";
  var color = pct>=70?"#DC2626":pct>=45?"#EA580C":pct>=25?"#CA8A04":"#16A34A";
  return {score:score,pct:pct,level:level,color:color,factors:factors};
}

/* â”€â”€ Helpers â”€â”€ */
function esc(s) { if (!s) return ""; var d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

function meterSVG(pct,color,level,size) {
  var r=(size-16)/2, circ=2*Math.PI*r;
  return '<div class="meter" style="width:'+size+'px;height:'+size+'px">'+
    '<svg viewBox="0 0 '+size+' '+size+'" width="'+size+'" height="'+size+'">'+
    '<circle cx="'+size/2+'" cy="'+size/2+'" r="'+r+'" fill="none" stroke="#1E293B" stroke-width="8"/>'+
    '<circle cx="'+size/2+'" cy="'+size/2+'" r="'+r+'" fill="none" stroke="'+color+'" stroke-width="8" '+
    'stroke-dasharray="'+(pct/100*circ)+' '+circ+'" stroke-linecap="round" '+
    'transform="rotate(-90 '+size/2+' '+size/2+')"/>'+
    '</svg>'+
    '<div class="meter-inner">'+
    '<span style="font-size:'+(size*0.23)+'px;font-weight:800;color:'+color+';font-family:DM Mono,monospace">'+pct+'</span>'+
    '<span style="font-size:'+(size*0.085)+'px;color:#94A3B8;letter-spacing:1px">'+level+'</span>'+
    '</div></div>';
}

function saveResults() {
  try { localStorage.setItem("catch-risk-results", JSON.stringify(results)); } catch(e) {}
}

function sendToSheet(result, risk) {
  try {
    fetch(SHEET_URL, {method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        timestamp:result.timestamp, shopName:result.shopName, area:result.area,
        address:result.address, floor:result.floor, tabelog:result.tabelog,
        tabelogCount:result.tabelogCount, gmap:result.gmap, gmapCount:result.gmapCount,
        cheapCourse:result.cheapCourse, crownName:result.crownName, sameAddress:result.sameAddress,
        catchKeywords:result.catchKeywords, riskPct:risk.pct, riskLevel:risk.level,
        riskFactors:risk.factors.map(function(f){return f.l+"(+"+f.w+")"}).join(", "),
        summary:result.summary
      })
    });
  } catch(e) { console.error("Sheet error:",e); }
}

/* â”€â”€ API Key UI â”€â”€ */
function renderApiSection() {
  var el = document.getElementById("apiSection");
  if (!apiKey.trim()) {
    el.innerHTML = '<div class="apibox">'+
      '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">'+
      '<span style="font-size:16px">ğŸ”‘</span>'+
      '<span style="font-size:13px;color:#CA8A04;font-weight:700">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span></div>'+
      '<input type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">'+
      '<p style="margin:8px 0 0;font-size:11px;color:#475569">ã‚­ãƒ¼ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼ˆAnthropic APIã¸ã®é€šä¿¡ã®ã¿ã«ä½¿ç”¨ï¼‰</p></div>';
    document.getElementById("apiKeyInput").addEventListener("change", function() {
      apiKey = this.value;
      try { localStorage.setItem("catch-risk-apikey", apiKey); } catch(e) {}
      renderApiSection();
    });
  } else {
    el.innerHTML = '<div class="api-ok"><span>ğŸ”‘ APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿</span>'+
      '<button id="clearApiBtn">ã‚­ãƒ¼ã‚’å¤‰æ›´</button></div>';
    document.getElementById("clearApiBtn").addEventListener("click", function() {
      apiKey = "";
      try { localStorage.removeItem("catch-risk-apikey"); } catch(e) {}
      renderApiSection();
    });
  }
}

/* â”€â”€ Merge â”€â”€ */
function mergeResult(newR, list) {
  var idx = -1;
  for (var i=0; i<list.length; i++) {
    if (list[i].shopName.replace(/\s/g,"") === newR.shopName.replace(/\s/g,"")) { idx=i; break; }
  }
  if (idx === -1) return [newR].concat(list);
  var old = list[idx];
  var merged = {};
  for (var k in newR) merged[k] = newR[k];
  var allKW = (old.catchKeywords||[]).concat(newR.catchKeywords||[]);
  merged.catchKeywords = allKW.filter(function(v,i,a){return a.indexOf(v)===i}).slice(0,10);
  var rest = [];
  for (var i=0; i<list.length; i++) { if (i!==idx) rest.push(list[i]); }
  return [merged].concat(rest);
}

function registerResult(result) {
  results = mergeResult(result, results);
  expandedIdx = 0;
  saveResults();
  sendToSheet(result, calcFromData(result));
  document.getElementById("queryInput").value = "";
  render();
}

/* â”€â”€ Confirm Dialog â”€â”€ */
function showConfirmDialog(result) {
  pendingResult = result;
  var ov = document.getElementById("confirmOverlay");
  ov.className = "overlay";
  ov.innerHTML = '<div class="modal">'+
    '<h3>ğŸ” åº—èˆ—ã®ç¢ºèª</h3>'+
    '<p style="margin:0 0 16px;font-size:12px;color:#64748B">æ¤œç´¢èªã€Œ'+esc(result.query)+'ã€ã«å¯¾ã—ã¦ä»¥ä¸‹ã®åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã“ã®åº—èˆ—ã§åˆã£ã¦ã„ã¾ã™ã‹ï¼Ÿ</p>'+
    '<div class="modal-detail">'+
    '<p style="margin:0 0 6px;font-size:15px;color:#F1F5F9;font-weight:700">'+esc(result.shopName)+'</p>'+
    '<p style="margin:0 0 4px;font-size:12px;color:#94A3B8">ğŸ“ '+esc(result.address)+'</p>'+
    (result.gmap!=null?'<p style="margin:0;font-size:12px;color:#94A3B8">â­ Gãƒãƒƒãƒ— â˜…'+result.gmap+'</p>':'')+
    '</div>'+
    '<div class="modal-btns">'+
    '<button id="confirmNo" style="background:#1E293B;color:#94A3B8">é•ã†åº—èˆ—ã§ã™</button>'+
    '<button id="confirmYes" style="background:#2563EB;color:#fff;font-weight:700">åˆã£ã¦ã„ã¾ã™</button>'+
    '</div></div>';
  document.getElementById("confirmNo").addEventListener("click", closeConfirm);
  document.getElementById("confirmYes").addEventListener("click", function() {
    if (pendingResult) registerResult(pendingResult);
    closeConfirm();
  });
}
function closeConfirm() {
  pendingResult = null;
  document.getElementById("confirmOverlay").className = "overlay hidden";
}

/* â”€â”€ Search â”€â”€ */
function showLoading(on) {
  var el = document.getElementById("loadingArea");
  var btn = document.getElementById("searchBtn");
  if (on) {
    el.className = "";
    el.innerHTML = '<div class="loading"><div class="spinner"></div>'+
      '<p style="color:#94A3B8;font-size:13px">ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’å®Ÿè¡Œä¸­â€¦</p>'+
      '<p style="color:#475569;font-size:11px;margin-top:8px">Googleãƒãƒƒãƒ—ãƒ»ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ»å£ã‚³ãƒŸã‚’æ¨ªæ–­æ¤œç´¢ã—ã¦ã„ã¾ã™ï¼ˆ10ã€œ20ç§’ï¼‰</p></div>';
    btn.disabled = true; btn.textContent = "æ¤œç´¢ä¸­â€¦";
  } else {
    el.className = "hidden"; el.innerHTML = "";
    btn.disabled = false; btn.textContent = "èª¿æŸ»é–‹å§‹";
  }
}
function showError(msg) {
  var el = document.getElementById("errorArea");
  el.className = ""; el.innerHTML = '<div class="error-box">'+esc(msg)+'</div>';
}
function hideError() {
  var el = document.getElementById("errorArea");
  el.className = "hidden"; el.innerHTML = "";
}

async function doSearch() {
  var q = document.getElementById("queryInput").value.trim();
  var a = document.getElementById("areaInput").value.trim();
  if (!q) return;
  if (!apiKey.trim()) { showError("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç”»é¢ä¸Šéƒ¨ã®ğŸ”‘æ¬„ï¼‰"); return; }
  showLoading(true);
  hideError();
  try {
    var resp = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {"Content-Type":"application/json","x-api-key":apiKey.trim(),"anthropic-version":"2023-06-01"},
      body: JSON.stringify({
        model:"claude-sonnet-4-20250514", max_tokens:2000, system:SYSTEM_PROMPT,
        messages:[{role:"user",content:"ä»¥ä¸‹ã®åº—èˆ—ã‚’èª¿æŸ»ã—ã¦ãã ã•ã„: "+q+(a?"ï¼ˆã‚¨ãƒªã‚¢: "+a+"ï¼‰":"")}],
        tools:[{type:"web_search_20250305",name:"web_search"}]
      })
    });
    var data = await resp.json();
    if (data.error) {
      showError("APIã‚¨ãƒ©ãƒ¼: "+(data.error.message||JSON.stringify(data.error)));
      showLoading(false); return;
    }
    var texts = [];
    if (data.content) {
      for (var i=0; i<data.content.length; i++) {
        if (data.content[i].type==="text") texts.push(data.content[i].text);
      }
    }
    var allText = texts.join("\n").replace(/```json|```/g,"").trim();
    var m = allText.match(/\{[\s\S]*\}/);
    if (!m) { showError("æ¤œç´¢çµæœã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åº—åã‚’æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); showLoading(false); return; }
    var parsed = JSON.parse(m[0]);
    var now = new Date();
    var pad = function(n){return ("0"+n).slice(-2)};
    var ts = now.getFullYear()+"/"+pad(now.getMonth()+1)+"/"+pad(now.getDate())+" "+pad(now.getHours())+":"+pad(now.getMinutes());
    var result = {
      id: Date.now()+"-"+Math.random().toString(36).slice(2,8),
      query:q, area:a, shopName:parsed.shopName||q,
      address:parsed.address||"ä¸æ˜", floor:parsed.floor,
      tabelog:parsed.tabelog, tabelogCount:parsed.tabelogCount,
      gmap:parsed.gmap, gmapCount:parsed.gmapCount,
      cheapCourse:parsed.cheapCourse, crownName:parsed.crownName||false,
      sameAddress:parsed.sameAddress, catchKeywords:parsed.catchKeywords||[],
      summary:parsed.summary||"", timestamp:ts
    };
    var sn = (parsed.shopName||"").toLowerCase();
    var ql = q.toLowerCase();
    var isExact = sn.indexOf(ql)>=0 || ql.indexOf(sn)>=0 || q.length>=10;
    if (isExact) { registerResult(result); } else { showConfirmDialog(result); }
  } catch(e) {
    showError("æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: "+e.message);
  }
  showLoading(false);
}

/* â”€â”€ Render â”€â”€ */
function render() {
  var area = document.getElementById("resultsArea");
  var empty = document.getElementById("emptyState");
  var stats = document.getElementById("statsArea");
  var isMobile = window.innerWidth < 480;
  var mSize = isMobile ? 80 : 120;

  if (results.length === 0) {
    area.innerHTML = "";
    stats.className = "hidden";
    empty.innerHTML = '<div class="empty"><div style="font-size:48px;margin-bottom:16px">ğŸ®</div>'+
      '<p style="font-size:14px;line-height:1.7">ä¸Šã®æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«å±…é…’å±‹ã®åº—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>'+
      'Googleãƒãƒƒãƒ—ãƒ»ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼ãƒ»å£ã‚³ãƒŸã‚’è‡ªå‹•æ¤œç´¢ã—ã€<br>ã‚­ãƒ£ãƒƒãƒå±…é…’å±‹ã®å¯èƒ½æ€§ã‚’åˆ¤å®šã—ã¾ã™ã€‚</p>'+
      '<p style="font-size:13px;color:#475569;margin-top:16px;line-height:1.7">èª¿æŸ»çµæœã¯Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è‡ªå‹•é›†ç´„ã•ã‚Œã¾ã™ã€‚</p></div>';
    return;
  }
  empty.innerHTML = "";
  var dc=0, cc=0;
  for (var i=0; i<results.length; i++) {
    var p = calcFromData(results[i]).pct;
    if (p>=70) dc++; else if (p>=45) cc++;
  }
  stats.className = "";
  stats.innerHTML = '<div class="stats">'+results.length+'åº—èˆ—èª¿æŸ»æ¸ˆ'+
    (dc>0?'<span style="color:#DC2626;margin-left:6px">ï¼ˆå±é™º'+dc+'ï¼‰</span>':'')+
    (cc>0?'<span style="color:#EA580C;margin-left:4px">ï¼ˆè¦æ³¨æ„'+cc+'ï¼‰</span>':'')+'</div>';

  var html = "";
  for (var idx=0; idx<results.length; idx++) {
    var r = results[idx];
    var risk = calcFromData(r);
    var bg = risk.pct>=70?"linear-gradient(135deg,#1a0505 0%,#0F172A 100%)":risk.pct>=45?"linear-gradient(135deg,#1a0f05 0%,#0F172A 100%)":"linear-gradient(135deg,#0F172A 0%,#0F172A 100%)";
    var bd = risk.pct>=70?"#7F1D1D":risk.pct>=45?"#7C2D12":"#1E293B";
    var sh = risk.pct>=70?"0 0 30px rgba(220,38,38,0.15)":"none";
    html += '<div class="card" style="background:'+bg+';border:1px solid '+bd+';box-shadow:'+sh+'" data-idx="'+idx+'">';
    html += '<div class="card-header">';
    html += meterSVG(risk.pct, risk.color, risk.level, mSize);
    html += '<div style="flex:1;min-width:0">';
    html += '<h3>'+esc(r.shopName)+'</h3>';
    html += '<p class="addr">'+esc(r.address)+(r.area?'<span class="area-badge">'+esc(r.area)+'</span>':'')+'</p>';
    html += '<div class="tags">';
    if (r.tabelog!=null) html+='<span class="tag" style="background:'+(r.tabelog<3.1?"#7F1D1D":"#1E293B")+';color:'+(r.tabelog<3.1?"#FCA5A5":"#94A3B8")+'">é£Ÿã¹ãƒ­ã‚° '+r.tabelog+'</span>';
    if (r.gmap!=null) html+='<span class="tag" style="background:#1E293B;color:#94A3B8">Gãƒãƒƒãƒ— â˜…'+r.gmap+'</span>';
    if (r.cheapCourse!=null && r.cheapCourse<3300) html+='<span class="tag" style="background:#7C2D12;color:#FDBA74">é£²æ”¾'+r.cheapCourse+'å††</span>';
    html += '</div>';
    html += '<p class="ts">'+esc(r.timestamp)+'</p>';
    html += '</div></div>';

    if (expandedIdx === idx) {
      html += '<div class="detail">';
      if (r.summary) html += '<p class="summary-box">'+esc(r.summary)+'</p>';
      html += '<h4 style="color:#F1F5F9;font-size:14px;margin:0 0 12px">ãƒªã‚¹ã‚¯è¦å› åˆ†æ</h4>';
      if (risk.factors.length===0) html+='<p style="color:#64748B;font-size:13px">ç‰¹ç­†ã™ã¹ããƒªã‚¹ã‚¯è¦å› ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
      for (var fi=0; fi<risk.factors.length; fi++) {
        var f = risk.factors[fi];
        var fbg = f.w>=3?"#DC2626":f.w>=2?"#EA580C":f.w>=1?"#CA8A04":"#475569";
        html += '<div class="factor"><span class="fw" style="background:'+fbg+'">+'+f.w+'</span><div><span style="color:#E2E8F0;font-size:13px;font-weight:600">'+esc(f.l)+'</span><span style="color:#64748B;font-size:12px;margin-left:8px">'+esc(f.det)+'</span></div></div>';
      }
      if (r.catchKeywords && r.catchKeywords.length>0) {
        html += '<div style="margin-top:16px"><h4 style="color:#FCA5A5;font-size:13px;margin:0 0 8px">å£ã‚³ãƒŸã‹ã‚‰æ¤œå‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h4>';
        for (var ki=0; ki<r.catchKeywords.length; ki++) {
          html += '<div class="kw-item">ã€Œ'+esc(r.catchKeywords[ki])+'ã€</div>';
        }
        html += '</div>';
      }
      if (r.sameAddress) html += '<div class="same-addr-box">âš  åŒä½æ‰€ã®åˆ¥åº—èˆ—: '+esc(r.sameAddress)+'</div>';
      html += '</div>';
    }
    html += '</div>';
  }
  area.innerHTML = html;

  // Attach click handlers
  var cards = area.querySelectorAll(".card");
  for (var ci=0; ci<cards.length; ci++) {
    cards[ci].addEventListener("click", function() {
      var i = parseInt(this.getAttribute("data-idx"));
      expandedIdx = (expandedIdx===i) ? null : i;
      render();
    });
  }
}

/* â”€â”€ Init â”€â”€ */
document.getElementById("searchBtn").addEventListener("click", doSearch);
document.getElementById("queryInput").addEventListener("keydown", function(e){if(e.key==="Enter")doSearch()});
document.getElementById("areaInput").addEventListener("keydown", function(e){if(e.key==="Enter")doSearch()});
renderApiSection();
render();
</script>
</body>
</html>
