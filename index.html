<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>キャッチ居酒屋可能性指数 — Catch Izakaya Risk Index</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #020617; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;

/* ─── Risk Meter ─── */
function RiskMeter({ pct, color, level, size = 120 }) {
  const [animPct, setAnimPct] = useState(0);
  useEffect(() => { const t = setTimeout(() => setAnimPct(pct), 150); return () => clearTimeout(t); }, [pct]);
  const r = (size - 16) / 2, circ = 2 * Math.PI * r;
  return (
    <div style={{ position: "relative", width: size, height: size, flexShrink: 0 }}>
      <svg viewBox={`0 0 ${size} ${size}`} width={size} height={size}>
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="#1E293B" strokeWidth="8" />
        <circle cx={size/2} cy={size/2} r={r} fill="none" stroke={color} strokeWidth="8"
          strokeDasharray={`${(animPct/100)*circ} ${circ}`} strokeLinecap="round"
          transform={`rotate(-90 ${size/2} ${size/2})`}
          style={{ transition: "stroke-dasharray 1.2s cubic-bezier(.4,0,.2,1)" }} />
      </svg>
      <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
        <span style={{ fontSize: size*0.23, fontWeight: 800, color, fontFamily: "'DM Mono', monospace" }}>{animPct}</span>
        <span style={{ fontSize: size*0.085, color: "#94A3B8", letterSpacing: 1 }}>{level}</span>
      </div>
    </div>
  );
}

/* ─── Score Calculation ─── */
function calcFromData(d) {
  const factors = []; let score = 0;
  if (d.floor != null && d.floor >= 4) { factors.push({ l: "空中階（高層）", det: `${d.floor}F`, w: 2 }); score += 2; }
  else if (d.floor != null && d.floor >= 2) { factors.push({ l: "空中階", det: `${d.floor}F`, w: 1 }); score += 1; }
  if (d.cheapCourse != null && d.cheapCourse < 2000) { factors.push({ l: "非現実的低価格", det: `飲放付${d.cheapCourse}円`, w: 2 }); score += 2; }
  else if (d.cheapCourse != null && d.cheapCourse < 3300) { factors.push({ l: "低価格コース", det: `${d.cheapCourse}円`, w: 1 }); score += 1; }
  if (d.catchKeywords && d.catchKeywords.length >= 3) { factors.push({ l: "「キャッチ/ぼったくり」多数", det: `${d.catchKeywords.length}件検出`, w: 3 }); score += 3; }
  else if (d.catchKeywords && d.catchKeywords.length > 0) { factors.push({ l: "「キャッチ/ぼったくり」検出", det: `${d.catchKeywords.length}件`, w: 2 }); score += 2; }
  if (d.sameAddress) { factors.push({ l: "同住所に別店舗", det: d.sameAddress, w: 1 }); score += 1; }
  if (d.crownName) { factors.push({ l: "SEO的冠語パターン", det: "「個室」「完全個室」等を店名に使用", w: 1 }); score += 1; }
  if (d.gmap != null && d.gmap <= 3.5) { factors.push({ l: "Gマップ低評価", det: `★${d.gmap}`, w: 1 }); score += 1; }
  if (d.tabelog != null && d.gmap != null) {
    const diff = d.gmap - d.tabelog;
    if (diff >= 0.7) { factors.push({ l: "【参考】評点乖離", det: `Gマップ★${d.gmap} vs 食べログ${d.tabelog}（差${diff.toFixed(1)}）`, w: 0 }); }
  }
  if (d.tabelog != null && d.tabelog <= 3.02) { factors.push({ l: "【参考】食べログ低評価", det: `${d.tabelog}`, w: 0 }); }
  if (d.gmapCount >= 500 && (d.tabelog == null || d.tabelog < 3.1)) {
    factors.push({ l: "【参考】口コミ数の異常", det: `Gマップ${d.gmapCount}件 × 食べログ${d.tabelog ?? "未掲載"}`, w: 0 });
  }
  const maxScore = 10;
  const pct = Math.min(Math.round((score / maxScore) * 100), 100);
  const level = pct >= 70 ? "危険" : pct >= 45 ? "要注意" : pct >= 25 ? "やや注意" : "低リスク";
  const color = pct >= 70 ? "#DC2626" : pct >= 45 ? "#EA580C" : pct >= 25 ? "#CA8A04" : "#16A34A";
  return { score, pct, level, color, factors };
}

/* ─── System Prompt ─── */
const SYSTEM_PROMPT = `あなたは飲食店の客引き・ぼったくりリスクを調査するアシスタントです。
ウェブ検索を使って以下の情報を収集し、JSON形式のみで回答してください。
マークダウンのバッククォートは不要です。

【必須検索】
検索1: 「(店名) ホットペッパー」→ 住所・階数・飲み放題付きコース最安価格・同ビル内の別店舗を確認
検索2: 「(店名) キャッチ ぼったくり 口コミ」→ キャッチ・客引き・ぼったくりに関する口コミを検索
検索3: 「(店名) Googleマップ 口コミ 評価」→ Gマップの星評価・口コミ件数を取得

検索結果に食べログの情報が含まれていた場合は、評点と口コミ数も記録してください（専用の検索は不要）。

回答はJSON形式のみ。

{
  "shopName": "正式店名",
  "address": "住所（ビル名・階数を含む）",
  "floor": 階数の数値（B1Fなら-1、1Fならnull、不明ならnull）,
  "tabelog": 食べログ評点（検索結果に含まれていた場合のみ、なければnull）,
  "tabelogCount": 食べログ口コミ件数（同上、なければnull）,
  "gmap": Googleマップ星評価（数値、不明ならnull）,
  "gmapCount": Googleマップ口コミ件数（数値、不明ならnull）,
  "cheapCourse": 最安の飲み放題付きコース価格（数値、不明ならnull）,
  "crownName": 店名に「個室」「居酒屋」「完全個室」等のSEO冠語があるか（true/false）,
  "sameAddress": 同じビル・住所にある別の飲食店名（文字列、なければnull）,
  "catchKeywords": 「キャッチ/客引き/ぼったくり/rip-off」関連の口コミ（配列、最大5件）,
  "summary": 特記事項（1〜2文）
}`;

/* ─── Local Storage helpers ─── */
const STORAGE_KEY = "catch-risk-results";

function loadSharedResults() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) return JSON.parse(data);
  } catch (e) { console.error("Load error:", e); }
  return [];
}

function saveSharedResults(results) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(results));
  } catch (e) { console.error("Save error:", e); }
}

/* ─── Google Sheets Integration ─── */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxnZEpb_L_nLHRx3Iwn4L-gWQG6c1qdseRf0-MrW8VLIdlI8ZZKSfMY0dImEnDA1wB0/exec";

function sendToSheet(result, riskData) {
  try {
    fetch(SHEET_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        timestamp: result.timestamp,
        shopName: result.shopName,
        area: result.area,
        address: result.address,
        floor: result.floor,
        tabelog: result.tabelog,
        tabelogCount: result.tabelogCount,
        gmap: result.gmap,
        gmapCount: result.gmapCount,
        cheapCourse: result.cheapCourse,
        crownName: result.crownName,
        sameAddress: result.sameAddress,
        catchKeywords: result.catchKeywords,
        riskPct: riskData.pct,
        riskLevel: riskData.level,
        riskFactors: riskData.factors.map(f => `${f.l}(+${f.w})`).join(", "),
        summary: result.summary
      })
    });
  } catch (e) { console.error("Sheet send error:", e); }
}

/* ─── Excel Export ─── */
function exportToExcel(results) {
  const rows = results.map((r, i) => {
    const risk = calcFromData(r);
    return {
      "No.": i + 1, "店名": r.shopName, "エリア": r.area || "", "住所": r.address,
      "階数": r.floor != null ? `${r.floor}F` : "",
      "食べログ評点": r.tabelog ?? "", "食べログ口コミ数": r.tabelogCount ?? "",
      "Gマップ評点": r.gmap ?? "", "Gマップ口コミ数": r.gmapCount ?? "",
      "最安飲放コース": r.cheapCourse ?? "", "冠語": r.crownName ? "○" : "",
      "同住所店舗": r.sameAddress ?? "",
      "キャッチ関連口コミ": (r.catchKeywords || []).join(" / "),
      "リスクスコア": risk.pct, "判定": risk.level,
      "リスク要因": risk.factors.map(f => `${f.l}(+${f.w})`).join(", "),
      "特記事項": r.summary, "調査日時": r.timestamp || ""
    };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  ws["!cols"] = [
    { wch: 4 }, { wch: 28 }, { wch: 14 }, { wch: 30 }, { wch: 6 },
    { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 12 },
    { wch: 12 }, { wch: 5 }, { wch: 20 }, { wch: 40 },
    { wch: 10 }, { wch: 8 }, { wch: 40 }, { wch: 40 }, { wch: 18 }
  ];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "調査結果");
  const criteria = [
    { "判定基準": "【スコアリング対象】", "加点": "" },
    { "判定基準": "所在階 4F以上", "加点": "+2" },
    { "判定基準": "所在階 2〜3F", "加点": "+1" },
    { "判定基準": "飲放付コース 2,000円未満", "加点": "+2" },
    { "判定基準": "飲放付コース 3,300円未満", "加点": "+1" },
    { "判定基準": "口コミに「キャッチ/ぼったくり」3件以上", "加点": "+3" },
    { "判定基準": "口コミに「キャッチ/ぼったくり」1〜2件", "加点": "+2" },
    { "判定基準": "同住所に別店舗あり", "加点": "+1" },
    { "判定基準": "SEO的冠語（個室/完全個室等）", "加点": "+1" },
    { "判定基準": "Gマップ ★3.5以下", "加点": "+1" },
    {},
    { "判定基準": "【参考情報（スコア非加算）】", "加点": "" },
    { "判定基準": "食べログ↔Gマップ評点乖離", "加点": "参考" },
    { "判定基準": "食べログ低評価（3.02以下）", "加点": "参考" },
    { "判定基準": "Gマップ口コミ数異常（500件超×食べログ3.1未満）", "加点": "参考" },
    {},
    { "判定基準": "最大スコア: 10点（100%換算）", "加点": "" },
    { "判定基準": "■ 70〜100: 危険  ■ 45〜69: 要注意  ■ 25〜44: やや注意  ■ 0〜24: 低リスク" },
  ];
  const ws2 = XLSX.utils.json_to_sheet(criteria);
  ws2["!cols"] = [{ wch: 50 }, { wch: 8 }];
  XLSX.utils.book_append_sheet(wb, ws2, "スコアリング基準");
  XLSX.writeFile(wb, `キャッチ調査_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* ─── Tab Button ─── */
function TabBtn({ active, children, onClick }) {
  return (
    <button onClick={onClick} style={{
      background: active ? "#1E293B" : "transparent",
      border: `1px solid ${active ? "#475569" : "#1E293B"}`,
      color: active ? "#F1F5F9" : "#475569",
      padding: "6px 18px", borderRadius: 20, fontSize: 13,
      cursor: "pointer", fontWeight: active ? 700 : 400,
      transition: "all 0.2s", fontFamily: "'Noto Sans JP', sans-serif"
    }}>{children}</button>
  );
}

/* ─── Main App ─── */
function LiveCatchRiskApp() {
  const [query, setQuery] = useState("");
  const [area, setArea] = useState("");
  const [loading, setLoading] = useState(false);
  const [progress, setProgress] = useState("");
  const [results, setResults] = useState([]);
  const [expandedIdx, setExpandedIdx] = useState(null);
  const [error, setError] = useState(null);
  const [view, setView] = useState("cards");
  const [isAdmin, setIsAdmin] = useState(false);
  const [showPwModal, setShowPwModal] = useState(false);
  const [pwInput, setPwInput] = useState("");
  const [pwError, setPwError] = useState(false);
  const [pendingResult, setPendingResult] = useState(null);
  const [showConfirm, setShowConfirm] = useState(false);
  const ADMIN_PW = "mma";

  useEffect(() => {
    setResults(loadSharedResults());
  }, []);

  function handlePwSubmit() {
    if (pwInput === ADMIN_PW) {
      setIsAdmin(true); setShowPwModal(false); setPwInput(""); setPwError(false);
    } else { setPwError(true); }
  }

  async function doSearch() {
    if (!query.trim()) return;
    setLoading(true); setError(null); setPendingResult(null); setShowConfirm(false);
    setProgress("ウェブ検索を実行中…ホットペッパー・Googleマップ・口コミを調査しています");
    try {
      const resp = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          system: SYSTEM_PROMPT,
          messages: [{ role: "user", content: `以下の店舗を調査してください: ${query.trim()}${area.trim() ? `（エリア: ${area.trim()}）` : ""}` }],
          tools: [{ type: "web_search_20250305", name: "web_search" }]
        })
      });
      const data = await resp.json();
      setProgress("データを解析中…");
      const textBlocks = (data.content || []).filter(b => b.type === "text").map(b => b.text).join("\n");
      let parsed = null;
      try {
        const cleaned = textBlocks.replace(/```json|```/g, "").trim();
        const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
        if (jsonMatch) parsed = JSON.parse(jsonMatch[0]);
      } catch (e) { console.error("Parse error:", e, textBlocks); }
      if (parsed) {
        const now = new Date();
        const ts = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
        const result = {
          id: `${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
          query: query.trim(), area: area.trim(), shopName: parsed.shopName || query.trim(),
          address: parsed.address || "不明", floor: parsed.floor,
          tabelog: parsed.tabelog, tabelogCount: parsed.tabelogCount,
          gmap: parsed.gmap, gmapCount: parsed.gmapCount,
          cheapCourse: parsed.cheapCourse, crownName: parsed.crownName || false,
          sameAddress: parsed.sameAddress, catchKeywords: parsed.catchKeywords || [],
          summary: parsed.summary || "", timestamp: ts,
        };
        function mergeWithExisting(newResult, existingResults) {
          const idx = existingResults.findIndex(r =>
            r.shopName.replace(/\s/g, "") === newResult.shopName.replace(/\s/g, "")
          );
          if (idx === -1) return [newResult, ...existingResults];
          const old = existingResults[idx];
          const mergedKW = [...new Set([...(old.catchKeywords || []), ...(newResult.catchKeywords || [])])].slice(0, 10);
          const merged = { ...newResult, catchKeywords: mergedKW };
          const rest = existingResults.filter((_, i) => i !== idx);
          return [merged, ...rest];
        }
        const q = query.trim().toLowerCase();
        const sn = (parsed.shopName || "").toLowerCase();
        const isExactish = sn.includes(q) || q.includes(sn) || q.length >= 10;
        if (isExactish) {
          const updated = mergeWithExisting(result, results);
          setResults(updated);
          setExpandedIdx(0);
          setQuery("");
          saveSharedResults(updated);
          sendToSheet(result, calcFromData(result));
        } else {
          setPendingResult(result);
          setShowConfirm(true);
        }
      } else {
        setError("検索結果を解析できませんでした。店名を正確に入力してください。");
      }
    } catch (e) {
      console.error("Search error:", e);
      setError("検索中にエラーが発生しました: " + e.message);
    }
    setLoading(false); setProgress("");
  }

  function confirmResult(accept) {
    if (accept && pendingResult) {
      function mergeConfirm(newR, existing) {
        const idx = existing.findIndex(r => r.shopName.replace(/\s/g, "") === newR.shopName.replace(/\s/g, ""));
        if (idx === -1) return [newR, ...existing];
        const old = existing[idx];
        const mergedKW = [...new Set([...(old.catchKeywords || []), ...(newR.catchKeywords || [])])].slice(0, 10);
        const merged = { ...newR, catchKeywords: mergedKW };
        const rest = existing.filter((_, i) => i !== idx);
        return [merged, ...rest];
      }
      const updated = mergeConfirm(pendingResult, results);
      setResults(updated);
      setExpandedIdx(0);
      setQuery("");
      saveSharedResults(updated);
      sendToSheet(pendingResult, calcFromData(pendingResult));
    }
    setPendingResult(null);
    setShowConfirm(false);
  }

  function removeResult(idx) {
    const updated = results.filter((_, i) => i !== idx);
    setResults(updated);
    if (expandedIdx === idx) setExpandedIdx(null);
    saveSharedResults(updated);
  }

  const dangerCount = results.filter(r => calcFromData(r).pct >= 70).length;
  const cautionCount = results.filter(r => calcFromData(r).pct >= 45 && calcFromData(r).pct < 70).length;

  return (
    <div style={{
      minHeight: "100vh",
      background: "linear-gradient(180deg, #020617 0%, #0F172A 40%, #020617 100%)",
      color: "#F1F5F9", fontFamily: "'Noto Sans JP', sans-serif", padding: "0 0 60px"
    }}>
      {/* Header */}
      <div style={{
        padding: "36px 20px 28px",
        background: "linear-gradient(180deg, rgba(220,38,38,0.08) 0%, transparent 100%)",
        borderBottom: "1px solid #1E293B"
      }}>
        <div style={{ maxWidth: 960, margin: "0 auto" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 6 }}>
            <span style={{ fontSize: 26 }}>🔍</span>
            <span style={{ background: "#DC2626", color: "#fff", padding: "3px 12px", borderRadius: 6, fontSize: 10, fontWeight: 700, letterSpacing: 1.5 }}>LIVE SEARCH</span>
          </div>
          <h1 style={{
            margin: 0, fontSize: 24, fontWeight: 800, lineHeight: 1.3,
            background: "linear-gradient(135deg, #F1F5F9 0%, #94A3B8 100%)",
            WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent"
          }}>キャッチ居酒屋可能性指数</h1>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap" }}>
            <p style={{ margin: "4px 0 0", fontSize: 13, color: "#64748B" }}>Catch Izakaya Risk Index — v0.7</p>
            {!isAdmin ? (
              <button onClick={() => setShowPwModal(true)} style={{
                background: "transparent", border: "1px solid #1E293B", borderRadius: 8,
                color: "#475569", fontSize: 12, padding: "4px 12px", cursor: "pointer",
                display: "flex", alignItems: "center", gap: 4
              }}>🔒 管理者</button>
            ) : (
              <span style={{ fontSize: 12, color: "#16A34A", display: "flex", alignItems: "center", gap: 4 }}>
                🔓 管理者モード
                <button onClick={() => setIsAdmin(false)} style={{
                  background: "transparent", border: "none", color: "#475569",
                  fontSize: 11, cursor: "pointer", textDecoration: "underline", marginLeft: 4
                }}>ログアウト</button>
              </span>
            )}
          </div>
          <p style={{ margin: "10px 0 0", fontSize: 11, color: "#475569", lineHeight: 1.8 }}>
            本ツールの調査対象は「酒類の提供を主とし、飲み放題付きコースを提供する飲食店」（居酒屋型飲食店）です。
            店名に「居酒屋」を含まない業態（海鮮ダイニング・個室和食等）も、上記の要件を満たす場合は対象となります。
          </p>
        </div>
      </div>

      <div style={{ maxWidth: 960, margin: "0 auto", padding: "24px 20px 0" }}>
        {/* Search Box */}
        <div style={{
          display: "flex", gap: 10, marginBottom: 12,
          background: "#0F172A", border: "1px solid #1E293B", borderRadius: 14, padding: 8, alignItems: "center",
          flexWrap: "wrap"
        }}>
          <input type="text" value={query} onChange={e => setQuery(e.target.value)}
            onKeyDown={e => e.key === "Enter" && !loading && doSearch()}
            placeholder="店名（例：○○居酒屋）" disabled={loading}
            style={{ flex: "2 1 180px", background: "transparent", border: "none", outline: "none", color: "#F1F5F9", fontSize: 15, padding: "10px 14px", fontFamily: "'Noto Sans JP', sans-serif", minWidth: 0 }} />
          <div style={{ width: 1, height: 24, background: "#1E293B", flexShrink: 0 }} />
          <input type="text" value={area} onChange={e => setArea(e.target.value)}
            onKeyDown={e => e.key === "Enter" && !loading && doSearch()}
            placeholder="エリア（例：歌舞伎町）" disabled={loading}
            style={{ flex: "1 1 120px", background: "transparent", border: "none", outline: "none", color: "#94A3B8", fontSize: 14, padding: "10px 14px", fontFamily: "'Noto Sans JP', sans-serif", minWidth: 0 }} />
          <button onClick={doSearch} disabled={loading || !query.trim()} style={{
            background: loading ? "#1E293B" : "#DC2626", color: "#fff", border: "none",
            borderRadius: 10, padding: "10px 24px", fontSize: 14, fontWeight: 700,
            cursor: loading ? "wait" : "pointer", opacity: (!query.trim() && !loading) ? 0.4 : 1,
            transition: "all 0.2s", fontFamily: "'Noto Sans JP', sans-serif", whiteSpace: "nowrap"
          }}>{loading ? "検索中…" : "調査開始"}</button>
        </div>

        {/* Privacy Notice */}
        <div style={{
          display: "flex", alignItems: "flex-start", gap: 8, marginBottom: 20,
          background: "#0F172A", border: "1px solid #1E293B", borderRadius: 10, padding: "10px 14px"
        }}>
          <span style={{ fontSize: 14, flexShrink: 0, marginTop: 1 }}>🔐</span>
          <p style={{ margin: 0, fontSize: 11, color: "#64748B", lineHeight: 1.7 }}>
            本ツールは入力された店名および公開グルメサイトから取得した評点・口コミ情報のみを記録します。利用者の個人情報は一切収集されません。調査結果はブラウザ内に保存され、管理者のみExcelダウンロードが可能です。
          </p>
        </div>

        {/* Loading search */}
        {loading && (
          <div style={{ background: "#0F172A", border: "1px solid #1E293B", borderRadius: 14, padding: "20px 24px", marginBottom: 20, textAlign: "center" }}>
            <div style={{ width: 40, height: 40, border: "3px solid #1E293B", borderTopColor: "#DC2626", borderRadius: "50%", margin: "0 auto 14px", animation: "spin 1s linear infinite" }} />
            <p style={{ color: "#94A3B8", fontSize: 13, margin: 0 }}>{progress}</p>
            <p style={{ color: "#475569", fontSize: 11, margin: "8px 0 0" }}>Googleマップ・ホットペッパー・口コミを横断検索しています（10〜20秒）</p>
          </div>
        )}
        {error && <div style={{ background: "#1a0505", border: "1px solid #7F1D1D", borderRadius: 14, padding: "16px 20px", marginBottom: 20, color: "#FCA5A5", fontSize: 13 }}>{error}</div>}

        {/* View Toggle + Export */}
        {results.length > 0 && (
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 16, flexWrap: "wrap", gap: 10 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
              <TabBtn active={view === "cards"} onClick={() => setView("cards")}>カード表示</TabBtn>
              <TabBtn active={view === "table"} onClick={() => setView("table")}>一覧表示</TabBtn>
              <span style={{ fontSize: 12, color: "#475569", marginLeft: 8 }}>
                {results.length}店舗調査済
                {dangerCount > 0 && <span style={{ color: "#DC2626", marginLeft: 6 }}>（危険{dangerCount}）</span>}
                {cautionCount > 0 && <span style={{ color: "#EA580C", marginLeft: 4 }}>（要注意{cautionCount}）</span>}
              </span>
            </div>
            {isAdmin && (
              <button onClick={() => exportToExcel(results)} style={{
                background: "linear-gradient(135deg, #065F46 0%, #047857 100%)",
                color: "#fff", border: "none", borderRadius: 10,
                padding: "8px 20px", fontSize: 13, fontWeight: 700,
                cursor: "pointer", fontFamily: "'Noto Sans JP', sans-serif",
                display: "flex", alignItems: "center", gap: 6, transition: "all 0.2s"
              }}>
                <span style={{ fontSize: 16 }}>📥</span> Excelダウンロード（{results.length}件）
              </button>
            )}
          </div>
        )}

        {/* ═══ Card View ═══ */}
        {view === "cards" && results.map((r, idx) => {
          const risk = calcFromData(r);
          const expanded = expandedIdx === idx;
          return (
            <div key={r.id || idx} style={{
              background: risk.pct >= 70 ? "linear-gradient(135deg, #1a0505 0%, #0F172A 100%)" : risk.pct >= 45 ? "linear-gradient(135deg, #1a0f05 0%, #0F172A 100%)" : "linear-gradient(135deg, #0F172A 0%, #0F172A 100%)",
              border: `1px solid ${risk.pct >= 70 ? "#7F1D1D" : risk.pct >= 45 ? "#7C2D12" : "#1E293B"}`,
              borderRadius: 16, padding: "20px 24px", marginBottom: 12, transition: "all 0.3s",
              boxShadow: risk.pct >= 70 ? "0 0 30px rgba(220,38,38,0.15)" : "none"
            }}>
              <div style={{ display: "flex", alignItems: "center", gap: 20, cursor: "pointer" }} onClick={() => setExpandedIdx(expanded ? null : idx)}>
                <RiskMeter pct={risk.pct} color={risk.color} level={risk.level} size={window.innerWidth < 480 ? 80 : 120} />
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between" }}>
                    <h3 style={{ margin: 0, fontSize: window.innerWidth < 480 ? 14 : 17, fontWeight: 700, color: "#F1F5F9", lineHeight: 1.4 }}>{r.shopName}</h3>
                    {isAdmin && <button onClick={e => { e.stopPropagation(); removeResult(idx); }} title="削除" style={{
                      background: "transparent", border: "none", color: "#334155", cursor: "pointer",
                      fontSize: 16, padding: "2px 6px", borderRadius: 4, flexShrink: 0
                    }}>✕</button>}
                  </div>
                  <p style={{ margin: "4px 0 0", fontSize: 12, color: "#64748B", wordBreak: "break-all" }}>{r.address}{r.area ? <span style={{ marginLeft: 8, background: "#1E293B", color: "#94A3B8", padding: "2px 8px", borderRadius: 10, fontSize: 11 }}>{r.area}</span> : null}</p>
                  <div style={{ display: "flex", gap: 6, marginTop: 8, flexWrap: "wrap" }}>
                    {r.tabelog != null && <span style={{ background: r.tabelog < 3.1 ? "#7F1D1D" : "#1E293B", color: r.tabelog < 3.1 ? "#FCA5A5" : "#94A3B8", padding: "2px 8px", borderRadius: 20, fontSize: 11, fontWeight: 600 }}>食べログ {r.tabelog}</span>}
                    {r.gmap != null && <span style={{ background: "#1E293B", color: "#94A3B8", padding: "2px 8px", borderRadius: 20, fontSize: 11, fontWeight: 600 }}>Gマップ ★{r.gmap}</span>}
                    {r.cheapCourse != null && r.cheapCourse < 3300 && <span style={{ background: "#7C2D12", color: "#FDBA74", padding: "2px 8px", borderRadius: 20, fontSize: 11, fontWeight: 600 }}>飲放{r.cheapCourse}円</span>}
                  </div>
                  <p style={{ margin: "4px 0 0", fontSize: 10, color: "#334155" }}>{r.timestamp}</p>
                </div>
              </div>
              {expanded && (
                <div style={{ marginTop: 20, paddingTop: 16, borderTop: "1px solid #1E293B" }}>
                  {r.summary && <p style={{ background: "#1E293B", padding: "12px 16px", borderRadius: 10, fontSize: 13, color: "#CBD5E1", lineHeight: 1.7, margin: "0 0 16px" }}>{r.summary}</p>}
                  <h4 style={{ color: "#F1F5F9", fontSize: 14, margin: "0 0 12px" }}>リスク要因分析</h4>
                  {risk.factors.length === 0 && <p style={{ color: "#64748B", fontSize: 13 }}>特筆すべきリスク要因は検出されませんでした。</p>}
                  {risk.factors.map((f, i) => (
                    <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 10, marginBottom: 8 }}>
                      <span style={{ background: f.w >= 3 ? "#DC2626" : f.w >= 2 ? "#EA580C" : f.w >= 1 ? "#CA8A04" : "#475569", color: "#fff", padding: "2px 8px", borderRadius: 6, fontSize: 11, fontWeight: 700, whiteSpace: "nowrap", minWidth: 28, textAlign: "center" }}>+{f.w}</span>
                      <div>
                        <span style={{ color: "#E2E8F0", fontSize: 13, fontWeight: 600 }}>{f.l}</span>
                        <span style={{ color: "#64748B", fontSize: 12, marginLeft: 8 }}>{f.det}</span>
                      </div>
                    </div>
                  ))}
                  {r.catchKeywords && r.catchKeywords.length > 0 && (
                    <div style={{ marginTop: 16 }}>
                      <h4 style={{ color: "#FCA5A5", fontSize: 13, margin: "0 0 8px" }}>口コミから検出されたキーワード</h4>
                      {r.catchKeywords.map((q, i) => (
                        <div key={i} style={{ background: "#1E293B", borderLeft: "3px solid #DC2626", padding: "8px 12px", marginBottom: 6, borderRadius: "0 8px 8px 0", color: "#CBD5E1", fontSize: 12, fontStyle: "italic", lineHeight: 1.5 }}>「{q}」</div>
                      ))}
                    </div>
                  )}
                  {r.sameAddress && <div style={{ marginTop: 12, background: "#1E293B", padding: "10px 14px", borderRadius: 10, fontSize: 12, color: "#FDBA74" }}>⚠ 同住所の別店舗: {r.sameAddress}</div>}
                </div>
              )}
            </div>
          );
        })}

        {/* ═══ Table View ═══ */}
        {view === "table" && results.length > 0 && (
          <div style={{ overflowX: "auto", borderRadius: 14, border: "1px solid #1E293B" }}>
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12, fontFamily: "'Noto Sans JP', sans-serif" }}>
              <thead>
                <tr style={{ background: "#0F172A" }}>
                  {["No.", "店名", "エリア", "階", "Gマップ", "最安コース", "スコア", "判定", "キャッチ"].map(h => (
                    <th key={h} style={{ padding: "10px 8px", color: "#94A3B8", fontWeight: 600, textAlign: "left", borderBottom: "1px solid #1E293B", whiteSpace: "nowrap", fontSize: 11 }}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {results.map((r, i) => {
                  const risk = calcFromData(r);
                  return (
                    <tr key={r.id || i} style={{ borderBottom: "1px solid #1E293B", background: i % 2 === 0 ? "transparent" : "rgba(15,23,42,0.5)" }}>
                      <td style={{ padding: "8px", color: "#64748B" }}>{i + 1}</td>
                      <td style={{ padding: "8px", color: "#F1F5F9", fontWeight: 600 }}>{r.shopName}</td>
                      <td style={{ padding: "8px", color: "#64748B", fontSize: 11 }}>{r.area || "-"}</td>
                      <td style={{ padding: "8px", color: r.floor >= 4 ? "#FCA5A5" : "#94A3B8" }}>{r.floor != null ? `${r.floor}F` : "-"}</td>
                      <td style={{ padding: "8px", color: "#94A3B8" }}>{r.gmap != null ? `★${r.gmap}` : "-"}</td>
                      <td style={{ padding: "8px", color: r.cheapCourse != null && r.cheapCourse < 2000 ? "#FCA5A5" : "#94A3B8" }}>{r.cheapCourse != null ? `${r.cheapCourse}円` : "-"}</td>
                      <td style={{ padding: "8px" }}>
                        <span style={{ background: risk.color, color: "#fff", padding: "2px 10px", borderRadius: 10, fontWeight: 700, fontSize: 12, fontFamily: "'DM Mono', monospace" }}>{risk.pct}</span>
                      </td>
                      <td style={{ padding: "8px", color: risk.color, fontWeight: 700, fontSize: 12 }}>{risk.level}</td>
                      <td style={{ padding: "8px", color: r.catchKeywords.length > 0 ? "#FCA5A5" : "#334155" }}>
                        {r.catchKeywords.length > 0 ? `${r.catchKeywords.length}件` : "-"}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}

        {/* Empty state */}
        {results.length === 0 && !loading && (
          <div style={{ textAlign: "center", padding: "48px 20px", color: "#334155" }}>
            <div style={{ fontSize: 48, marginBottom: 16 }}>🏮</div>
            <p style={{ fontSize: 14, lineHeight: 1.7 }}>
              上の検索ボックスに居酒屋の店名を入力してください。<br />
              Googleマップ・ホットペッパー・口コミを自動検索し、<br />
              キャッチ居酒屋の可能性を判定します。
            </p>
            <p style={{ fontSize: 13, color: "#475569", marginTop: 16, lineHeight: 1.7 }}>
              調査結果はブラウザ内に保存されます。<br />
              管理者のみ「Excelダウンロード」で一括出力できます。
            </p>
          </div>
        )}

        {/* Legend */}
        <div style={{ marginTop: 32, background: "#0F172A", border: "1px solid #1E293B", borderRadius: 16, padding: "20px 24px" }}>
          <h4 style={{ margin: "0 0 14px", fontSize: 14, color: "#F1F5F9", fontWeight: 700 }}>スコアリング基準</h4>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "6px 16px", fontSize: 11, color: "#94A3B8", lineHeight: 1.8 }}>
            <div>• 所在階4F以上 → +2 / 2-3F → +1</div>
            <div>• 飲放付2,000円未満 → +2 / 3,300円未満 → +1</div>
            <div>• 口コミ「キャッチ/ぼったくり」3件超 → +3</div>
            <div>• 口コミ「キャッチ/ぼったくり」1-2件 → +2</div>
            <div>• 同住所に別店舗 → +1</div>
            <div>• SEO的冠語（個室/完全個室等）→ +1</div>
            <div>• Gマップ★3.5以下 → +1</div>
            <div style={{ color: "#475569" }}>※ 食べログ評点は参考表示（スコア非加算）</div>
          </div>
          <div style={{ marginTop: 14, display: "flex", gap: 14, fontSize: 11, flexWrap: "wrap" }}>
            <span><span style={{ color: "#DC2626", fontWeight: 700 }}>■ 70〜100</span> 危険</span>
            <span><span style={{ color: "#EA580C", fontWeight: 700 }}>■ 45〜69</span> 要注意</span>
            <span><span style={{ color: "#CA8A04", fontWeight: 700 }}>■ 25〜44</span> やや注意</span>
            <span><span style={{ color: "#16A34A", fontWeight: 700 }}>■ 0〜24</span> 低リスク</span>
          </div>
        </div>

        <div style={{ marginTop: 24, textAlign: "center", fontSize: 11, color: "#334155", lineHeight: 1.8 }}>
          <p>客引き問題調査ツール ─ 北陸大学 山本研究室</p>
          <p>v0.7 ─ 調査データに基づく参考指標です</p>
        </div>
      </div>

      {/* Confirmation Dialog */}
      {showConfirm && pendingResult && (
        <div style={{
          position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)",
          display: "flex", alignItems: "center", justifyContent: "center", zIndex: 9998, padding: 20
        }} onClick={() => confirmResult(false)}>
          <div onClick={e => e.stopPropagation()} style={{
            background: "#0F172A", border: "1px solid #1E293B", borderRadius: 16,
            padding: "32px 28px", maxWidth: 380, width: "100%", boxShadow: "0 20px 60px rgba(0,0,0,0.5)"
          }}>
            <h3 style={{ margin: "0 0 6px", fontSize: 16, color: "#F1F5F9", fontWeight: 700 }}>🔍 店舗の確認</h3>
            <p style={{ margin: "0 0 16px", fontSize: 12, color: "#64748B" }}>
              検索語「{pendingResult.query}」に対して以下の店舗が見つかりました。この店舗で合っていますか？
            </p>
            <div style={{ background: "#020617", border: "1px solid #1E293B", borderRadius: 12, padding: "16px", marginBottom: 20 }}>
              <p style={{ margin: "0 0 6px", fontSize: 15, color: "#F1F5F9", fontWeight: 700 }}>{pendingResult.shopName}</p>
              <p style={{ margin: "0 0 4px", fontSize: 12, color: "#94A3B8" }}>📍 {pendingResult.address}</p>
              {pendingResult.gmap != null && <p style={{ margin: "0", fontSize: 12, color: "#94A3B8" }}>⭐ Gマップ ★{pendingResult.gmap}</p>}
            </div>
            <div style={{ display: "flex", gap: 10 }}>
              <button onClick={() => confirmResult(false)} style={{
                flex: 1, background: "#1E293B", color: "#94A3B8", border: "none",
                borderRadius: 10, padding: "12px", fontSize: 13, cursor: "pointer",
                fontFamily: "'Noto Sans JP', sans-serif"
              }}>違う店舗です</button>
              <button onClick={() => confirmResult(true)} style={{
                flex: 1, background: "#2563EB", color: "#fff", border: "none",
                borderRadius: 10, padding: "12px", fontSize: 13, fontWeight: 700, cursor: "pointer",
                fontFamily: "'Noto Sans JP', sans-serif"
              }}>合っています</button>
            </div>
          </div>
        </div>
      )}

      {/* Password Modal */}
      {showPwModal && (
        <div style={{
          position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)",
          display: "flex", alignItems: "center", justifyContent: "center", zIndex: 9999, padding: 20
        }} onClick={() => { setShowPwModal(false); setPwInput(""); setPwError(false); }}>
          <div onClick={e => e.stopPropagation()} style={{
            background: "#0F172A", border: "1px solid #1E293B", borderRadius: 16,
            padding: "32px 28px", maxWidth: 320, width: "100%", boxShadow: "0 20px 60px rgba(0,0,0,0.5)"
          }}>
            <h3 style={{ margin: "0 0 6px", fontSize: 16, color: "#F1F5F9", fontWeight: 700 }}>🔒 管理者認証</h3>
            <p style={{ margin: "0 0 20px", fontSize: 12, color: "#64748B" }}>パスワードを入力してください</p>
            <input type="password" value={pwInput}
              onChange={e => { setPwInput(e.target.value); setPwError(false); }}
              onKeyDown={e => e.key === "Enter" && handlePwSubmit()}
              autoFocus placeholder="パスワード"
              style={{
                width: "100%", background: "#020617", border: `1px solid ${pwError ? "#DC2626" : "#1E293B"}`,
                borderRadius: 10, padding: "10px 14px", color: "#F1F5F9", fontSize: 14,
                outline: "none", fontFamily: "'Noto Sans JP', sans-serif", boxSizing: "border-box"
              }} />
            {pwError && <p style={{ color: "#FCA5A5", fontSize: 12, margin: "8px 0 0" }}>パスワードが違います</p>}
            <div style={{ display: "flex", gap: 10, marginTop: 20 }}>
              <button onClick={() => { setShowPwModal(false); setPwInput(""); setPwError(false); }} style={{
                flex: 1, background: "#1E293B", color: "#94A3B8", border: "none",
                borderRadius: 10, padding: "10px", fontSize: 13, cursor: "pointer"
              }}>キャンセル</button>
              <button onClick={handlePwSubmit} style={{
                flex: 1, background: "#DC2626", color: "#fff", border: "none",
                borderRadius: 10, padding: "10px", fontSize: 13, fontWeight: 700, cursor: "pointer"
              }}>認証</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<LiveCatchRiskApp />, document.getElementById("root"));
</script>
</body>
</html>
